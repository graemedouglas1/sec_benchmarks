#TRUSTED a805a5c3e32a1ad27e83e4d775098a7f535407260c08d434930685847d2736df0f0840ad670f65463b12c00502d4765a015cd608692f7bd79e9e1e1e30773b7e1a157ed70512a20731e6c765a48677700d4593e2d96d5614c98b18b16f342e0bccd03c722357ca7bf5b28a86ead79b52b0673faa8ff9da33892f6514af38e9d4cef2faf0b19ce81edde01d50098e2afe04f36d02929613d9e7659adbd34745e619ba6a07ff55c968cd09366fbd054f467f88a0779f96722c83bfbb8fbebb8d682d4c218c3f68bb54275d7f5f9013a678a62f78d695c0c82e2bfe87312c979cf86da7c76164af42cc13de18bcf61d677c35350db79713bcdd431b5485e84cec8b4a995a4ca1705b38af863bad515e1761de378d722fdf21a8f6ec9c3beeb2a3f221e569bba40d47989a8272b8d73531445ad83beb7ffb9d6f785fa7d185b876c092b39324481aef2a6745f1d8eaaec5b4bdc453da84e15c9c7bf49c83b6874938717cbb317344a8bf09901e8e6e988750477fae154bcf7c717dc3c4c489081d3a7ff35b009799e9de490be5363ff3f2d1104baaf269085e4c418f54b73ca85a25b48e9ba8c85f0c18337bf3d67271b5223c2227e0d774c835d3566906fa8d7b5041b7d40d2936c1f230669732b28e381c0ac7e48faabbd8305810730c76f59e4db4d5ea6c023ba158ff5d73c320b08f0c0f0c5c1e7fb1475c6b4a45802c105404
#TRUST-RSA-SHA256 36daf4276675d70053f1a101673dfbc9c2b09e7a172cf9c9e1bc94752eb54ea3f7c10b6ac820f271e8ddfbb75984980aa6396c91e32b5f9f7ea02593e57b4063288d146537ce51e76a1d8305e5c115dc2196dd1ece732b77115bb00642283e39f26b9d30aababbd4ec74e78bbff0af0585d9e23fbd18d90bdcb0c235606544e22398ea3389768dcc92bbdd3ab80d3e8a457a6dc70dd71d565c7f2e52894c97fcb529dd74ab2deedb46a10bd7862d853bec6f4044a8f138fe13bec14dfade13e6b3d7769f92a5da0764b17f5dd44c72cbb837f007b4788b0402d6a09a926f1d55da6ae091e5e69b83638f8474dcdf3d1fc6310db4d9612bc6dd71bb76f904101c94fd6a9d93cbd19ad6cc616625fcf2cb821ade4c1594551edb3ae52e696863f3c660ac8e10c58044a738e774e9ba6790cb610d0fb59bc688e9d0de4ea0085ef72c0db11c0595815514bf6fda305171aaa7e0019650402e4f1892bea14171c8a0c0a46dfe1281d5df8474f47e2c98db8813d51afe4256801cec558c5a172bec5ab7917ec6f1d6002e261a4748d444aaeceaf8ac9680216428c43650f27d096e0c37317805135ef772ead39572e7fc9a7f68eeb7b19011160989f79687f841325ddc6bf4d816abcca247ed4f5e488221a900d052a4a0451e284a705359592650c70bdda5db5d10ed5e7818a3b9465d5a32a7f9315dd3044836118d1bd899b7cbfb
#
# This script is Copyright (C) 2004-2024 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This script is released under the Tenable Subscription License and
# may not be used from within scripts released under another license
# without authorization from Tenable, Inc.
#
# See the following licenses for details:
#
# http://static.tenable.com/prod_docs/Nessus_6_SLA_and_Subscription_Agreement.pdf
#
# @PROFESSIONALFEED@
#
# $Revision: 1.0 $
# $Date: 2024/11/06 $
#
# description	: CIS Microsoft Azure Foundations v3.0.0 audit
#
#<ui_metadata>
#<display_name>CIS Microsoft Azure Foundations v3.0.0 L2</display_name>
#<spec>
#  <type>CIS</type>
#  <name>Microsoft Azure Foundations</name>
#  <profile>L2</profile>
#  <version>3.0.0</version>
#  <link>https://workbench.cisecurity.org/benchmarks/16820</link>
#</spec>
#<labels>microsoft,azure,cloud</labels>
#<benchmark_refs>CCE,CSCv6,CSCv7,CSCv8,LEVEL</benchmark_refs>
#</ui_metadata>

<check_type:"microsoft_azure">

<report type:"WARNING">
  description : "2.1.3 Ensure that 'Multi-Factor Auth Status' is 'Enabled' for all Non-Privileged Users"
  info        : "[IMPORTANT - Please read the section overview: If your organization pays for Microsoft Entra ID licensing (included in Microsoft 365 E3, E5, or F5, and EM&S E3 or E5 licenses) and CAN use Conditional Access, ignore the recommendations in this section and proceed to the Conditional Access section.]

Enable multi-factor authentication for all non-privileged users.

Rationale:

Multi-factor authentication requires an individual to present a minimum of two separate forms of authentication before access is granted. Multi-factor authentication provides additional assurance that the individual attempting to gain access is who they claim to be. With multi-factor authentication, an attacker would need to compromise at least two different authentication mechanisms, increasing the difficulty of compromise and thus reducing the risk.

Impact:

Users would require two forms of authentication before any access is granted. Also, this requires an overhead for managing dual forms of authentication.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID blade

Under Manage, click Users

Click on the Per-User MFA button in the top row menu

Check the box next to each user

Click Enable MFA

Click Enable

Other Options within Azure Portal
Follow Microsoft Azure documentation and enable multi-factor authentication in your environment.
https://docs.microsoft.com/en-us/azure/active-directory/authentication/tutorial-enable-azure-mfa
Enabling and configuring MFA is a multi-step process. Here are some additional resources on the process within Microsoft Entra ID:
https://learn.microsoft.com/en-us/entra/identity/conditional-access/howto-conditional-access-policy-admin-mfa
https://learn.microsoft.com/en-us/entra/identity/authentication/howto-mfa-getstarted#enable-multi-factor-authentication-with-conditional-access
https://learn.microsoft.com/en-us/entra/identity/authentication/howto-mfa-mfasettings

Default Value:

By default, multi-factor authentication is disabled for all users."
  reference   : "800-171|3.5.3,800-53|IA-2(1),800-53|IA-2(2),800-53r5|AC-19,800-53r5|IA-2(1),800-53r5|IA-2(2),CN-L3|7.1.2.7(b),CN-L3|7.1.3.1(a),CN-L3|7.1.3.1(e),CN-L3|8.1.4.1(a),CN-L3|8.1.4.2(a),CN-L3|8.5.4.1(a),CSCv7|16.3,CSCv8|6.3,CSCv8|6.4,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ITSG-33|IA-2(1),ITSG-33|IA-2(2),LEVEL|2M,NESA|T5.4.2,NIAv2|AM2,NIAv2|AM8,NIAv2|AM14b,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.1 Ensure Trusted Locations Are Defined"
  info        : "Microsoft Entra ID Conditional Access allows an organization to configure Named locations and configure whether those locations are trusted or untrusted. These settings provide organizations the means to specify Geographical locations for use in conditional access policies, or define actual IP addresses and IP ranges and whether or not those IP addresses and/or ranges are trusted by the organization.

Rationale:

Defining trusted source IP addresses or ranges helps organizations create and enforce Conditional Access policies around those trusted or untrusted IP addresses and ranges. Users authenticating from trusted IP addresses and/or ranges may have less access restrictions or access requirements when compared to users that try to authenticate to Microsoft Entra ID from untrusted locations or untrusted source IP addresses/ranges.

Impact:

When configuring Named locations, the organization can create locations using Geographical location data or by defining source IP addresses or ranges. Configuring Named locations using a Country location does not provide the organization the ability to mark those locations as trusted, and any Conditional Access policy relying on those Countries location setting will not be able to use the All trusted locations setting within the Conditional Access policy. They instead will have to rely on the Select locations setting. This may add additional resource requirements when configuring and will require thorough organizational testing.

In general, Conditional Access policies may completely prevent users from authenticating to Microsoft Entra ID, and thorough testing is recommended. To avoid complete lockout, a 'Break Glass' account with full Global Administrator rights is recommended in the event all other administrators are locked out of authenticating to Microsoft Entra ID. This 'Break Glass' account should be excluded from Conditional Access Policies and should be configured with the longest pass phrase feasible in addition to a FIDO2 security key or certificate kept in a very secure physical location. This account should only be used in the event of an emergency and complete administrator lockout.

NOTE: Starting July 2024, Microsoft will begin requiring MFA for All Users - including Break Glass Accounts. By the end of October 2024, this requirement will be enforced. Physical FIDO2 security keys, or a certificate kept on secure removable storage can fulfill this MFA requirement. If opting for a physical device, that device should be kept in a very secure, documented physical location.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

In the Azure Portal, navigate to Microsoft Entra ID

Under Manage, click Security

Under Protect, click Conditional Access

Under Manage, click Named locations

Within the Named locations blade, click on IP ranges location

Enter a name for this location setting in the Name text box

Click on the + sign

Add an IP Address Range in CIDR notation inside the text box that appears

Click on the Add button

Repeat steps 7 through 9 for each IP Range that needs to be added

If the information entered are trusted ranges, select the Mark as trusted location check box

Once finished, click on Create

Remediate from PowerShell
Create a new trusted IP-based Named location policy

[System.Collections.Generic.List'1[Microsoft.Open.MSGraph.Model.IpRange]]$ipRanges = @()
$ipRanges.Add('<first IP range in CIDR notation>')
$ipRanges.Add('<second IP range in CIDR notation>')
$ipRanges.Add('<third IP range in CIDR notation>')
New-MgIdentityConditionalAccessNamedLocation -dataType '#microsoft.graph.ipNamedLocation' -DisplayName '<name of IP Named location policy>' -IsTrusted $true -IpRanges $ipRanges

Set an existing IP-based Named location policy to trusted

Update-MgIdentityConditionalAccessNamedLocation -PolicyId '<ID of the policy>' -dataType '#microsoft.graph.ipNamedLocation' -IsTrusted $true

Default Value:

By default, no locations are configured under the Named locations blade within the Microsoft Entra ID Conditional Access blade."
  reference   : "800-171|3.1.1,800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-53|AC-2(1),800-53|AC-3,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|AC-2(1),800-53r5|AC-3,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(j),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|11.1,CSCv8|6.7,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.13.1.3,ITSG-33|AC-2(1),ITSG-33|AC-3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2M,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.2.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NESA|T7.6.5,NIAv2|AM3,NIAv2|AM28,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|NS5j,NIAv2|SS3,NIAv2|SS14e,NIAv2|SS15a,NIAv2|SS29,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|2.3,TBA-FIISB|31.1,TBA-FIISB|43.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.2 Ensure that an exclusionary Geographic Access Policy is considered"
  info        : "CAUTION: If these policies are created without first auditing and testing the result, misconfiguration can potentially lock out administrators or create undesired access issues.

Conditional Access Policies can be used to block access from geographic locations that are deemed out-of-scope for your organization or application. The scope and variables for this policy should be carefully examined and defined.

Rationale:

Conditional Access, when used as a deny list for the tenant or subscription, is able to prevent ingress or egress of traffic to countries that are outside of the scope of interest (e.g.: customers, suppliers) or jurisdiction of an organization. This is an effective way to prevent unnecessary and long-lasting exposure to international threats such as APTs.

Impact:

Microsoft Entra ID P1 or P2 is required. Limiting access geographically will deny access to users that are traveling or working remotely in a different part of the world. A point-to-site or site to site tunnel such as a VPN is recommended to address exceptions to geographic access policies.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal
Part 1 of 2 - Create the policy and enable it in Report-only mode.

From Azure Home open the portal menu in the top left, and select Microsoft Entra ID.

Scroll down in the menu on the left, and select Security.

Select on the left side Conditional Access.

Select Policies.

Click the + New policy button, then:

Provide a name for the policy.

Under Assignments, select Users then:

Under Include, select All users

Under Exclude, check Users and groups and only select emergency access accounts and service accounts (NOTE: Service accounts are excluded here because service accounts are non-interactive and cannot complete MFA)

Under Assignments, select Target resources then:

Under Include, select All cloud apps

Leave Exclude blank unless you have a well defined exception

Under Conditions, select Locations then:

Select Include, then add entries for locations for those that should be blocked

Select Exclude, then add entries for those that should be allowed (IMPORTANT: Ensure that all Trusted Locations are in the Exclude list.)

Under Access Controls, select Grant select Block Access.

Set Enable policy to Report-only.

Click Create.

Allow some time to pass to ensure the sign-in logs capture relevant conditional access events. These events will need to be reviewed to determine if additional considerations are necessary for your organization (e.g. legitimate locations are being blocked and investigation is needed for exception).
NOTE: The policy is not yet 'live,' since Report-only is being used to audit the effect of the policy.
Part 2 of 2 - Confirm that the policy is not blocking access that should be granted, then toggle to On.

With your policy now in report-only mode, return to the Microsoft Entra blade and click on Sign-in logs.

Review the recent sign-in events - click an event then review the event details (specifically the Report-only tab) to ensure:

The sign-in event you're reviewing occurred after turning on the policy in report-only mode

The policy name from step 6 above is listed in the Policy Name column

The Result column for the new policy shows that the policy was Not applied (indicating the location origin was not blocked)

If the above conditions are present, navigate back to the policy name in Conditional Access and open it.

Toggle the policy from Report-only to On.

Click Save.

Remediate from PowerShell
First, set up the conditions objects values before updating an existing conditional access policy or before creating a new one. You may need to use additional PowerShell cmdlets to retrieve specific IDs such as the Get-MgIdentityConditionalAccessNamedLocation which outputs the Location IDs for use with conditional access policies.

$conditions = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessConditionSet

$conditions.Applications = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessApplicationCondition
$conditions.Applications.IncludeApplications = <'All' | 'Office365' | 'app ID' | @('app ID 1', 'app ID 2', etc...>
$conditions.Applications.ExcludeApplications = <'Office365' | 'app ID' | @('app ID 1', 'app ID 2', etc...)>

$conditions.Users = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessUserCondition
$conditions.Users.IncludeUsers = <'All' | 'None' | 'GuestsOrExternalUsers' | 'Specific User ID' | @('User ID 1', 'User ID 2', etc.)>
$conditions.Users.ExcludeUsers = <'GuestsOrExternalUsers' | 'Specific User ID' | @('User ID 1', 'User ID 2', etc.)>
$conditions.Users.IncludeGroups = <'group ID' | 'All' | @('Group ID 1', 'Group ID 2', etc...)>
$conditions.Users.ExcludeGroups = <'group ID' | @('Group ID 1', 'Group ID 2', etc...)>
$conditions.Users.IncludeRoles = <'Role ID' | 'All' | @('Role ID 1', 'Role ID 2', etc...)>
$conditions.Users.ExcludeRoles = <'Role ID' | @('Role ID 1', 'Role ID 2', etc...)>

$conditions.Locations = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessLocationCondition
$conditions.Locations.IncludeLocations = <'Location ID' | @('Location ID 1', 'Location ID 2', etc...) >
$conditions.Locations.ExcludeLocations = <'AllTrusted' | 'Location ID' | @('Location ID 1', 'Location ID 2', etc...)>

$controls = New-Object -TypeName Microsoft.Open.MSGraph.Model.ConditionalAccessGrantControls
$controls._Operator = 'OR'
$controls.BuiltInControls = 'block'

Next, update the existing conditional access policy with the condition set options configured with the previous commands.

Update-MgIdentityConditionalAccessPolicy -PolicyId <policy ID> -Conditions $conditions -GrantControls $controls

To create a new conditional access policy that complies with this best practice, run the following commands after creating the condition set above

New-MgIdentityConditionalAccessPolicy -Name 'Policy Name' -State <enabled|disabled> -Conditions $conditions -GrantControls $controls

Default Value:

This policy does not exist by default."
  reference   : "800-171|3.1.1,800-53|AC-2(1),800-53|AC-3,800-53r5|AC-2(1),800-53r5|AC-3,CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|12.1,CSCv8|6.7,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-2(1),ITSG-33|AC-3,LEVEL|2M,NESA|T4.2.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM3,NIAv2|AM28,NIAv2|NS5j,NIAv2|SS14e,NIAv2|SS29,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,TBA-FIISB|31.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.3 Ensure that an exclusionary Device code flow policy is considered"
  info        : "Conditional Access Policies can be used to prevent the Device code authentication flow. Device code flow should be permitted only for users that regularly perform duties that explicitly require the use of Device Code to authenticate, such as utilizing Azure with PowerShell.

Rationale:

Attackers use Device code flow in phishing attacks and, if successful, results in the attacker gaining access tokens and refresh tokens which are scoped to 'user_impersonation', which can perform any action the user has permission to perform.

Impact:

Microsoft Entra ID P1 or P2 is required.

This policy should be tested using the Report-only mode before implementation. Without a full and careful understanding of the accounts and personnel who require Device code authentication flow, implementing this policy can block authentication for users and devices who rely on Device code flow. For users and devices that rely on device code flow authentication, more secure alternatives should be implemented wherever possible.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal
Part 1 of 2 - Create the policy and enable it in Report-only mode.

From Azure Home open the portal menu in the top left and select Microsoft Entra ID.

Scroll down in the menu on the left and select Security.

Select on the left side Conditional Access.

Select Policies.

Click the + New policy button, then:

Provide a name for the policy.

Under Assignments, select Users then:

Under Include, select All users

Under Exclude, check Users and groups and only select emergency access accounts

Under Assignments, select Target resources then:

Under Include, select All cloud apps

Leave Exclude blank unless you have a well defined exception

Under Conditions > Authentication Flows, set Configure to Yes then:

Select Device code flow

Select Done

Under Access Controls > Grant, select Block Access.

Set Enable policy to Report-only.

Click Create.

Allow some time to pass to ensure the sign-in logs capture relevant conditional access events. These events will need to be reviewed to determine if additional considerations are necessary for your organization (e.g. many legitimate use cases of device code authentication are observed).

NOTE: The policy is not yet 'live,' since Report-only is being used to audit the effect of the policy.

Part 2 of 2 - Confirm that the policy is not blocking access that should be granted, then toggle to On.

With your policy now in report-only mode, return to the Microsoft Entra blade and click on Sign-in logs.

Review the recent sign-in events - click an event then review the event details (specifically the Report-only tab) to ensure:

The sign-in event you're reviewing occurred after turning on the policy in report-only mode

The policy name from step 6 above is listed in the Policy Name column

The Result column for the new policy shows that the policy was Not applied (indicating the device code authentication flow was not blocked)

If the above conditions are present, navigate back to the policy name in Conditional Access and open it.

Toggle the policy from Report-only to On.

Click Save.

Default Value:

This policy does not exist by default."
  reference   : "800-171|3.1.1,800-171|3.5.2,800-171|3.5.5,800-171|3.5.6,800-53|AC-1,800-53|AC-2,800-53|IA-4,800-53|IA-5,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|IA-4,800-53r5|IA-5,CN-L3|7.1.2.7(b),CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.10.6(c),CSCv7|12.4,CSCv8|6.1,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|IA-4,ITSG-33|IA-5,LEVEL|2M,NESA|M1.2.2,NESA|T5.2.3,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|NS5j,NIAv2|SS14e,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.4 Ensure that A Multi-factor Authentication Policy Exists for Administrative Groups"
  info        : "For designated users, they will be prompted to use their multi-factor authentication (MFA) process on login.

Rationale:

Enabling multi-factor authentication is a recommended setting to limit the use of Administrative accounts to authenticated personnel.

Impact:

There is an increased cost, as Conditional Access policies require Microsoft Entra ID P1. Similarly, MFA may require additional overhead to maintain. There is also a potential scenario in which the multi-factor authentication method can be lost, and administrative users are no longer able to log in. For this scenario, there should be an emergency access account. Please see References for creating this.

NOTE: Starting July 2024, Microsoft will begin requiring MFA for All Users - including Break Glass Accounts. By the end of October 2024, this requirement will be enforced. Physical FIDO2 security keys, or a certificate kept on secure removable storage can fulfill this MFA requirement. If opting for a physical device, that device should be kept in a very secure, documented physical location.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home open the Portal Menu in top left, and select Microsoft Entra ID.

Select Security.

Select Conditional Access.

Select Policies.

Click + New policy.

Enter a name for the policy.

Click the blue text under Users.

Select Select users and groups.

Select administrative groups this policy should apply to and click Select.

Under Exclude, check Users and groups.

Select users this policy not should apply to and click Select.

Click the blue text under Target resources.

Select All cloud apps.

Click the blue text under Grant.

Under Grant access, check Require multifactor authentication and click Select.

Set Enable policy to Report-only.

Click Create.

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On.

Default Value:

Starting October 2024, MFA will be required for all accounts by default."
  reference   : "800-171|3.5.3,800-53|IA-2(1),800-53r5|AC-19,800-53r5|IA-2(1),800-53r5|IA-2(2),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv7|16.3,CSCv8|6.4,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.5 Ensure that A Multi-factor Authentication Policy Exists for All Users"
  info        : "For designated users, they will be prompted to use their multi-factor authentication (MFA) process on logins.

Rationale:

Enabling multi-factor authentication is a recommended setting to limit the potential of accounts being compromised and limiting access to authenticated personnel.

Impact:

There is an increased cost, as Conditional Access policies require Microsoft Entra ID P1 or P2. Similarly, this may require additional overhead to maintain if users lose access to their MFA.

NOTE: Starting July 2024, Microsoft will begin requiring MFA for All Users - including Break Glass Accounts. By the end of October 2024, this requirement will be enforced. Physical FIDO2 security keys, or a certificate kept on secure removable storage can fulfill this MFA requirement. If opting for a physical device, that device should be kept in a very secure, documented physical location.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home open Portal menu in the top left, and select Microsoft Entra ID.

Select Security.

Select Conditional Access.

Select Policies.

Click + New policy.

Enter a name for the policy.

Click the blue text under Users.

Under Include, select All users.

Under Exclude, check Users and groups.

Select users this policy should not apply to and click Select.

Click the blue text under Target resources.

Select All cloud apps.

Click the blue text under Grant.

Under Grant access, check Require multifactor authentication and click Select.

Set Enable policy to Report-only.

Click Create.

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On.

Default Value:

Starting October 2024, MFA will be required for all accounts by default."
  reference   : "800-171|3.1.1,800-171|3.5.3,800-53|AC-2(1),800-53|AC-3,800-53|IA-2(1),800-53|IA-2(2),800-53r5|AC-2(1),800-53r5|AC-3,800-53r5|AC-19,800-53r5|IA-2(1),800-53r5|IA-2(2),CN-L3|7.1.2.7(b),CN-L3|7.1.3.1(a),CN-L3|7.1.3.1(e),CN-L3|7.1.3.2(d),CN-L3|8.1.4.1(a),CN-L3|8.1.4.2(a),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|16.3,CSCv8|6.3,CSCv8|6.4,CSCv8|6.7,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-2(1),ITSG-33|AC-3,ITSG-33|IA-2(1),ITSG-33|IA-2(2),LEVEL|2M,NESA|T4.2.1,NESA|T5.4.2,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM2,NIAv2|AM3,NIAv2|AM8,NIAv2|AM14b,NIAv2|AM28,NIAv2|AM36,NIAv2|NS5j,NIAv2|SS14e,NIAv2|SS29,NIAv2|VL3c,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|1.2,TBA-FIISB|31.1,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.6 Ensure Multi-factor Authentication is Required for Risky Sign-ins"
  info        : "Entra ID tracks the behavior of sign-in events. If the Entra ID domain is licensed with P2, the sign-in behavior can be used as a detection mechanism for additional scrutiny during the sign-in event. If this policy is set up, then Risky Sign-in events will prompt users to use multi-factor authentication (MFA) tokens on login for additional verification.

Rationale:

Enabling multi-factor authentication is a recommended setting to limit the potential of accounts being compromised and limiting access to authenticated personnel. Enabling this policy allows Entra ID's risk-detection mechanisms to force additional scrutiny on the login event, providing a deterrent response to potentially malicious sign-in events, and adding an additional authentication layer as a reaction to potentially malicious behavior.

Impact:

Risk Policies for Conditional Access require Microsoft Entra ID P2. Additional overhead to support or maintain these policies may also be required if users lose access to their MFA tokens.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu in the top left and select Microsoft Entra ID.

Select Security

Select Conditional Access.

Select Policies.

Click + New policy.

Enter a name for the policy.

Click the blue text under Users.

Under Include, select All users.

Under Exclude, check Users and groups.

Select users this policy should not apply to and click Select.

Click the blue text under Target resources.

Select All cloud apps.

Click the blue text under Conditions.

Select Sign-in risk.

Update the Configure toggle to Yes.

Check the sign-in risk level this policy should apply to, e.g. High and Medium.

Select Done.

Click the blue text under Grant and check Require multifactor authentication then click the Select button.

Click the blue text under Session then check Sign-in frequency and select Every time and click the Select button.

Set Enable policy to Report-only.

Click Create.

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On.

Default Value:

MFA is not enabled by default."
  reference   : "800-171|3.1.1,800-171|3.5.3,800-53|AC-2(1),800-53|AC-3,800-53|IA-2(1),800-53|IA-2(2),800-53r5|AC-2(1),800-53r5|AC-3,800-53r5|AC-19,800-53r5|IA-2(1),800-53r5|IA-2(2),CN-L3|7.1.2.7(b),CN-L3|7.1.3.1(a),CN-L3|7.1.3.1(e),CN-L3|7.1.3.2(d),CN-L3|8.1.4.1(a),CN-L3|8.1.4.2(a),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|16.3,CSCv8|6.3,CSCv8|6.4,CSCv8|6.7,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-2(1),ITSG-33|AC-3,ITSG-33|IA-2(1),ITSG-33|IA-2(2),LEVEL|2M,NESA|T4.2.1,NESA|T5.4.2,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM2,NIAv2|AM3,NIAv2|AM8,NIAv2|AM14b,NIAv2|AM28,NIAv2|AM36,NIAv2|NS5j,NIAv2|SS14e,NIAv2|SS29,NIAv2|VL3c,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|1.2,TBA-FIISB|31.1,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.7 Ensure Multi-factor Authentication is Required for Windows Azure Service Management API"
  info        : "This recommendation ensures that users accessing the Windows Azure Service Management API (i.e. Azure Powershell, Azure CLI, Azure Resource Manager API, etc.) are required to use multi-factor authentication (MFA) credentials when accessing resources through the Windows Azure Service Management API.

Rationale:

Administrative access to the Windows Azure Service Management API should be secured with a higher level of scrutiny to authenticating mechanisms. Enabling multi-factor authentication is recommended to reduce the potential for abuse of Administrative actions, and to prevent intruders or compromised admin credentials from changing administrative settings.

IMPORTANT: While this recommendation allows exceptions to specific Users or Groups, they should be very carefully tracked and reviewed for necessity on a regular interval through an Access Review process. It is important that this rule be built to include 'All Users' to ensure that all users not specifically excepted will be required to use MFA to access the Azure Service Management API.

Impact:

Conditional Access policies require Microsoft Entra ID P1 or P2 licenses. Similarly, they may require additional overhead to maintain if users lose access to their MFA. Any users or groups which are granted an exception to this policy should be carefully tracked, be granted only minimal necessary privileges, and conditional access exceptions should be regularly reviewed or investigated.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From the Azure Admin Portal dashboard, open Microsoft Entra ID.

Click Security in the Entra ID blade.

Click Conditional Access in the Security blade.

Click Policies in the Conditional Access blade.

Click + New policy.

Enter a name for the policy.

Click the blue text under Users.

Under Include, select All users.

Under Exclude, check Users and groups.

Select users or groups to be exempted from this policy (e.g. break-glass emergency accounts, and non-interactive service accounts) then click the Select button.

Click the blue text under Target resources.

Under Include, click the Select apps radio button.

Click the blue text under Select.

Check the box next to Windows Azure Service Management APIs then click the Select button.

Click the blue text under Grant.

Under Grant access check the box for Require multi-factor authentication then click the Select button.

Before creating, set Enable policy to Report-only.

Click Create.

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On.

Default Value:

MFA is not enabled by default for administrative actions."
  reference   : "800-171|3.5.3,800-53|IA-2(1),800-53r5|IA-2(1),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.2.8 Ensure Multi-factor Authentication is Required to access Microsoft Admin Portals"
  info        : "This recommendation ensures that users accessing Microsoft Admin Portals (i.e. Microsoft 365 Admin, Microsoft 365 Defender, Exchange Admin Center, Azure Portal, etc.) are required to use multi-factor authentication (MFA) credentials when logging into an Admin Portal.

Rationale:

Administrative Portals for Microsoft Azure should be secured with a higher level of scrutiny to authenticating mechanisms. Enabling multi-factor authentication is recommended to reduce the potential for abuse of Administrative actions, and to prevent intruders or compromised admin credentials from changing administrative settings.

IMPORTANT: While this recommendation allows exceptions to specific Users or Groups, they should be very carefully tracked and reviewed for necessity on a regular interval through an Access Review process. It is important that this rule be built to include 'All Users' to ensure that all users not specifically excepted will be required to use MFA to access Admin Portals.

Impact:

Conditional Access policies require Microsoft Entra ID P1 or P2 licenses. Similarly, they may require additional overhead to maintain if users lose access to their MFA. Any users or groups which are granted an exception to this policy should be carefully tracked, be granted only minimal necessary privileges, and conditional access exceptions should be reviewed or investigated.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From the Azure Admin Portal dashboard, open Microsoft Entra ID.

Click Security in the Entra ID blade.

Click Conditional Access in the Security blade.

Click Policies in the Conditional Access blade.

Click + New policy.

Enter a name for the policy.

Click the blue text under Users.

Under Include, select All users.

Under Exclude, check Users and groups.

Select users or groups to be exempted from this policy (e.g. break-glass emergency accounts, and non-interactive service accounts) then click the Select button.

Click the blue text under Target resources.

Under Include, click the Select apps radio button.

Click the blue text under Select.

Check the box next to Microsoft Admin Portals then click the Select button.

Click the blue text under Grant.

Under Grant access check the box for Require multifactor authentication then click the Select button.

Before creating, set Enable policy to Report-only.

Click Create.

After testing the policy in report-only mode, update the Enable policy setting from Report-only to On.

Default Value:

MFA is not enabled by default for administrative actions."
  reference   : "800-171|3.5.3,800-53|IA-2(1),800-53r5|IA-2(1),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.13 Ensure 'User consent for applications' Is Set To 'Allow for Verified Publishers'"
  info        : "Allow users to provide consent for selected permissions when a request is coming from a verified publisher.

Rationale:

If Microsoft Entra ID is running as an identity provider for third-party applications, permissions and consent should be limited to administrators or pre-approved. Malicious applications may attempt to exfiltrate data or abuse privileged user accounts.

Impact:

Enforcing this setting may create additional requests that administrators need to review.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID

Under Manage, select Enterprise applications

Under Security, select Consent and permissions'

Under Manage, select User consent settings

Under User consent for applications, select Allow user consent for apps from verified publishers, for selected permissions

Click Save

Default Value:

By default, User consent for applications is set to Allow user consent for apps."
  reference   : "800-171|3.4.1,800-171|3.4.7,800-171|3.4.8,800-171|3.4.9,800-53|CM-7(2),800-53|CM-7(5),800-53|CM-8(3),800-53|CM-10,800-53|CM-11,800-53r5|CM-7(2),800-53r5|CM-7(5),800-53r5|CM-8(3),800-53r5|CM-10,800-53r5|CM-11,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CSCv7|2.6,CSCv7|2.7,CSCv8|2.3,CSCv8|2.5,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.IP-1,CSF|PR.PT-3,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|PR.PS-01,CSF2.0|PR.PS-02,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.5.1,ISO/IEC-27001|A.12.6.2,ITSG-33|CM-7,ITSG-33|CM-7(2),ITSG-33|CM-8(3),LEVEL|2M,NESA|T1.2.1,NESA|T1.2.2,NIAv2|SS15a,PCI-DSSv3.2.1|2.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,SWIFT-CSCv1|2.3,SWIFT-CSCv1|5.1,TBA-FIISB|44.2.2,TBA-FIISB|49.2.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.16 Ensure that 'Guest invite restrictions' is set to 'Only users assigned to specific admin roles can invite guest users'"
  info        : "Restrict invitations to users with specific administrative roles only.

Rationale:

Restricting invitations to users with specific administrator roles ensures that only authorized accounts have access to cloud resources. This helps to maintain 'Need to Know' permissions and prevents inadvertent access to data.

By default the setting Guest invite restrictions is set to Anyone in the organization can invite guest users including guests and non-admins. This would allow anyone within the organization to invite guests and non-admins to the tenant, posing a security risk.

Impact:

With the option of Only users assigned to specific admin roles can invite guest users selected, users with specific admin roles will be in charge of sending invitations to the external users, requiring additional overhead by them to manage user accounts. This will mean coordinating with other departments as they are onboarding new users.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID

Under Manage, select External Identities

Select External collaboration settings

Under Guest invite settings, set Guest invite restrictions, to Only users assigned to specific admin roles can invite guest users

Click Save

Remediate from PowerShell
Enter the following:

Connect-MgGraph
Update-MgPolicyAuthorizationPolicy -AllowInvitesFrom 'adminsAndGuestInviters'

Default Value:

By default, Guest invite restrictions is set to Anyone in the organization can invite guest users including guests and non-admins"
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.5.2,800-171|3.5.5,800-171|3.5.6,800-53|AC-1,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|IA-4,800-53|IA-5,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|IA-4,800-53r5|IA-5,CN-L3|7.1.2.7(b),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.1.10.6(c),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|16.2,CSCv8|6.1,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(b),HIPAA|164.312(d),ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|IA-4,ITSG-33|IA-5,LEVEL|2A,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.2.3,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.18 Ensure that 'Restrict user ability to access groups features in the Access Pane' is Set to 'Yes'"
  info        : "Restrict access to group web interface in the Access Panel portal.

Rationale:

Self-service group management enables users to create and manage security groups or Office 365 groups in Microsoft Entra ID. Unless a business requires this day-to-day delegation for some users, self-service group management should be disabled. Any user can access the Access Panel, where they can reset their passwords, view their information, etc. By default, users are also allowed to access the Group feature, which shows groups, members, related resources (SharePoint URL, Group email address, Yammer URL, and Teams URL). By setting this feature to 'Yes', users will no longer have access to the web interface, but still have access to the data using the API. This is useful to prevent non-technical users from enumerating groups-related information, but technical users will still be able to access this information using APIs.

Impact:

Setting to Yes could create administrative overhead by customers seeking certain group memberships that will have to be manually managed by administrators with appropriate permissions.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID

Under Manage, select Groups

Under Settings, select General

Under Self Service Group Management, set Restrict user ability to access groups features in My Groups to Yes

Click Save

Default Value:

By default, Restrict user ability to access groups features in the Access Pane is set to No"
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.19 Ensure that 'Users can create security groups in Azure portals, API or PowerShell' is set to 'No'"
  info        : "Restrict security group creation to administrators only.

Rationale:

When creating security groups is enabled, all users in the directory are allowed to create new security groups and add members to those groups. Unless a business requires this day-to-day delegation, security group creation should be restricted to administrators only.

Impact:

Enabling this setting could create a number of requests that would need to be managed by an administrator.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID

Under Manage, select Groups

Under Settings, select General

Under Security Groups, set Users can create security groups in Azure portals, API or PowerShell to No

Click Save

Default Value:

By default, Users can create security groups in Azure portals, API or PowerShell is set to Yes"
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.20 Ensure that 'Owners can manage group membership requests in My Groups' is set to 'No'"
  info        : "Restrict security group management to administrators only.

Rationale:

Restricting security group management to administrators only prohibits users from making changes to security groups. This ensures that security groups are appropriately managed and their management is not delegated to non-administrators.

Impact:

Group Membership for user accounts will need to be handled by Admins and cause administrative overhead.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID

Under Manage, select Groups

Under Settings, select General

Under Self Service Group Management, set Owners can manage group membership requests in My Groups to No

Click Save

Default Value:

By default, Owners can manage group membership requests in My Groups is set to No."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.21 Ensure that 'Users can create Microsoft 365 groups in Azure portals, API or PowerShell' is set to 'No'"
  info        : "Restrict Microsoft 365 group creation to administrators only.

Rationale:

Restricting Microsoft 365 group creation to administrators only ensures that creation of Microsoft 365 groups is controlled by the administrator. Appropriate groups should be created and managed by the administrator and group creation rights should not be delegated to any other user.

Impact:

Enabling this setting could create a number of requests that would need to be managed by an administrator.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Entra ID

Under Manage, select Groups

Under Settings, select General

Under Microsoft 365 Groups, set Users can create Microsoft 365 groups in Azure portals, API or PowerShell to No

Click Save

Default Value:

By default, Users can create Microsoft 365 groups in Azure portals, API or PowerShell is set to Yes."
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-53|AC-2,800-53|AC-3,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53r5|AC-2,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.24 Ensure a Custom Role is Assigned Permissions for Administering Resource Locks"
  info        : "Resource locking is a powerful protection mechanism that can prevent inadvertent modification/deletion of resources within Azure subscriptions/Resource Groups and is a recommended NIST configuration.

Rationale:

Given the resource lock functionality is outside of standard Role Based Access Control(RBAC), it would be prudent to create a resource lock administrator role to prevent inadvertent unlocking of resources.

Impact:

By adding this role, specific permissions may be granted for managing just resource locks rather than needing to provide the wide Owner or User Access Administrator role, reducing the risk of the user being able to do unintentional damage.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

In the Azure portal, open a subscription or resource group where you want the custom role to be assigned.

Select Access control (IAM).

Click Add.

Select Add custom role.

In the Custom role name field enter Resource Lock Administrator.

In the Description field enter Can Administer Resource Locks.

For Baseline permissions select Start from scratch

Select Next.

In the Permissions tab select Add permissions.

In the Search for a permission box, type in Microsoft.Authorization/locks to search for permissions.

Click on the result.

Check the box next to Permission.

Select Add.

Select Review + create.

Select Create.

Assign the newly created role to the appropriate user.

Remediate from PowerShell:
Below is a power shell definition for a resource lock administrator role created at an Azure Management group level

Import-Module Az.Accounts
Connect-AzAccount

$role = Get-AzRoleDefinition 'User Access Administrator'
$role.Id = $null
$role.Name = 'Resource Lock Administrator'
$role.Description = 'Can Administer Resource Locks'
$role.Actions.Clear()
$role.Actions.Add('Microsoft.Authorization/locks/*')
$role.AssignableScopes.Clear()

* Scope at the Management group level Management group

$role.AssignableScopes.Add('/providers/Microsoft.Management/managementGroups/MG-Name')

New-AzRoleDefinition -Role $role
Get-AzureRmRoleDefinition 'Resource Lock Administrator'"
  reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-53|AC-2,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|MP-2,800-53r5|AC-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2M,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "2.25 Ensure That 'Subscription leaving Microsoft Entra tenant' and 'Subscription entering Microsoft Entra tenant' Is Set To 'Permit no one'"
  info        : "Users who are set as subscription owners are able to make administrative changes to the subscriptions and move them into and out of Microsoft Entra ID.

Rationale:

Permissions to move subscriptions in and out of a Microsoft Entra tenant must only be given to appropriate administrative personnel. A subscription that is moved into a Microsoft Entra tenant may be within a folder to which other users have elevated permissions. This prevents loss of data or unapproved changes of the objects within by potential bad actors.

Impact:

Subscriptions will need to have these settings turned off to be moved.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From the Azure Portal Home select the portal menu

Select Subscriptions

In the Advanced options drop-down menu, select Manage Policies

Set Subscription leaving Microsoft Entra tenant and Subscription entering Microsoft Entra tenant to Permit no one

Click Save changes

Default Value:

By default Subscription leaving Microsoft Entra tenant and Subscription entering Microsoft Entra tenant are set to Allow everyone (default)"
  reference   : "800-171|3.1.1,800-171|3.1.5,800-171|3.1.6,800-171|3.5.2,800-171|3.5.5,800-171|3.5.6,800-53|AC-1,800-53|AC-2,800-53|AC-2(1),800-53|AC-6(2),800-53|AC-6(5),800-53|IA-4,800-53|IA-5,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|AC-6(2),800-53r5|AC-6(5),800-53r5|IA-4,800-53r5|IA-5,CN-L3|7.1.2.7(b),CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.10.6(a),CN-L3|8.1.10.6(c),CSCv7|4.3,CSCv8|5.4,CSCv8|6.1,CSCv8|6.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.3,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|AC-2(1),ITSG-33|AC-6(2),ITSG-33|AC-6(5),ITSG-33|IA-4,ITSG-33|IA-5,LEVEL|2M,NESA|M1.2.2,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.2.3,NESA|T5.6.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|AM32,NIAv2|AM33,NIAv2|NS5j,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|5,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "3.1.1.2 Ensure that Microsoft Defender for Cloud Apps integration with Microsoft Defender for Cloud is Selected"
  info           : "This integration setting enables Microsoft Defender for Cloud Apps (formerly 'Microsoft Cloud App Security' or 'MCAS' - see additional info) to communicate with Microsoft Defender for Cloud.

Rationale:

Microsoft Defender for Cloud offers an additional layer of protection by using Azure Resource Manager events, which is considered to be the control plane for Azure. By analyzing the Azure Resource Manager records, Microsoft Defender for Cloud detects unusual or potentially harmful operations in the Azure subscription environment. Several of the preceding analytics are powered by Microsoft Defender for Cloud Apps. To benefit from these analytics, subscription must have a Cloud App Security license.

Microsoft Defender for Cloud Apps works only with Standard Tier subscriptions.

Impact:

Microsoft Defender for Cloud Apps works with Standard pricing tier Subscription. Choosing the Standard pricing tier of Microsoft Defender for Cloud incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

From Azure Home select the Portal Menu.

Select Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Select the subscription.

Select Integrations.

Check Allow Microsoft Defender for Cloud Apps to access my data.

Select Save.

Remediate from Azure CLI
Use the below command to enable Standard pricing tier for Storage Accounts

az account get-access-token --query '{subscription:subscription,accessToken:accessToken}' --out tsv | xargs -L1 bash -c 'curl -X PUT -H 'Authorization: Bearer $1' -H 'Content-Type: application/json' https://management.azure.com/subscriptions/<subscription_ID>/providers/Microsoft.Security/settings/MCAS?api-version=2021-06-01 -d@'input.json''

Where input.json contains the Request body json data as mentioned below.

{
  'id': '/subscriptions/<Your_Subscription_Id>/providers/Microsoft.Security/settings/MCAS',
  'kind': 'DataExportSetting',
  'type': 'Microsoft.Security/settings',
  'properties': {
    'enabled': true
  }
}

Default Value:

With Cloud App Security license, these alerts are enabled by default."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171|3.13.1,800-53|RA-5,800-53|SA-15,800-53|SC-7(8),800-53r5|RA-5,800-53r5|SA-15,800-53r5|SC-7(8),CN-L3|8.1.10.6(j),CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSCv8|13.10,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.AC-5,CSF|PR.IP-2,CSF|PR.IP-12,CSF|PR.PT-4,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|DE.CM-01,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ISO/IEC-27001|A.13.1.3,ITSG-33|RA-5,ITSG-33|SC-7(8),LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T4.5.4,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,NIAv2|SU4,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listSecurityCenterSettings"
  json_transform : '.[]|.subscriptionId as $id|.value[] | select(.name == "MCAS") |"Subscription ID: \($id), Name: \(.name), Enabled: \(.properties.enabled)"'
  expect         : "Name: MCAS, Enabled: true"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.3.1 Ensure That Microsoft Defender for Servers Is Set to 'On'"
  info           : "Turning on Microsoft Defender for Servers enables threat detection for Servers, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for Servers allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC).

Impact:

Turning on Microsoft Defender for Servers in Microsoft Defender for Cloud incurs an additional cost per resource.

Two Defender for Servers plans exist:

Plan 1: Subscription only

Plan 2: Subscription and workspace"
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud

Under Management, select Environment Settings

Click on the subscription name

Click Defender plans in the left pane

Under Cloud Workload Protection (CWP), locate Server in the Plan column, set Status to On

Select Save

Remediate from Azure CLI
Run the following command:

az security pricing create -n VirtualMachines --tier 'standard'

Remediate from PowerShell
Run the following command:

Set-AzSecurityPricing -Name 'VirtualMachines' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender for Servers plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-53|RA-5,800-53|SI-3,800-53r5|RA-5,800-53r5|SI-3,CN-L3|7.1.3.6(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CSCv7|3.1,CSCv7|8.1,CSCv8|7.5,CSCv8|10.1,CSF|DE.CM-4,CSF|DE.CM-8,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.2.1,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SI-3,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|GS8a,PCI-DSSv3.2.1|5.1,PCI-DSSv3.2.1|5.1.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|5.2.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "VirtualMachines") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: VirtualMachines, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "3.1.3.2 Ensure that 'Vulnerability assessment for machines' component status is set to 'On'"
  info        : "Enable vulnerability assessment for machines on both Azure and hybrid (Arc enabled) machines.

Rationale:

Vulnerability assessment for machines scans for various security-related configurations and events such as system updates, OS vulnerabilities, and endpoint protection, then produces alerts on threat and vulnerability findings.

Impact:

Microsoft Defender for Servers plan 2 licensing is required, and configuration of Azure Arc introduces complexity beyond this recommendation.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu

Select Microsoft Defender for Cloud

Under Management, select Environment Settings

Select a subscription

Click on Settings & Monitoring

Set the Status of Vulnerability assessment for machines to On

Click Continue

Repeat the above for any additional subscriptions.

Default Value:

By default, Automatic provisioning of monitoring agent is set to Off."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "3.1.3.3 Ensure that 'Endpoint protection' component status is set to 'On'"
  info        : "The Endpoint protection component enables Microsoft Defender for Endpoint (formerly 'Advanced Threat Protection' or 'ATP' or 'WDATP' - see additional info) to communicate with Microsoft Defender for Cloud.

IMPORTANT: When enabling integration between DfE & DfC it needs to be taken into account that this will have some side effects that may be undesirable.

For server 2019 & above if defender is installed (default for these server SKUs) this will trigger a deployment of the new unified agent and link to any of the extended configuration in the Defender portal.

If the new unified agent is required for server SKUs of Win 2016 or Linux and lower there is additional integration that needs to be switched on and agents need to be aligned.

Rationale:

Microsoft Defender for Endpoint integration brings comprehensive Endpoint Detection and Response (EDR) capabilities within Microsoft Defender for Cloud. This integration helps to spot abnormalities, as well as detect and respond to advanced attacks on endpoints monitored by Microsoft Defender for Cloud.

MDE works only with Standard Tier subscriptions.

Impact:

Endpoint protection requires licensing and is included in these plans:

Defender for Servers plan 1

Defender for Servers plan 2

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

From Azure Home select the Portal Menu.

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Click Settings & monitoring.

Set the Status for Endpoint protection to On.

Click Continue.

Remediate from Azure CLI
Use the below command to enable Standard pricing tier for Storage Accounts

az account get-access-token --query '{subscription:subscription,accessToken:accessToken}' --out tsv | xargs -L1 bash -c 'curl -X PUT -H 'Authorization: Bearer $1' -H 'Content-Type: application/json' https://management.azure.com/subscriptions/<subscriptionID>/providers/Microsoft.Security/settings/WDATP?api-version=2021-06-01 -d@'input.json''

Where input.json contains the Request body json data as mentioned below.

{
  'id': '/subscriptions/<Your_Subscription_Id>/providers/Microsoft.Security/settings/WDATP',
  'kind': 'DataExportSettings',
  'type': 'Microsoft.Security/settings',
  'properties': {
    'enabled': true
  }
}

Default Value:

By default, Endpoint protection is off."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-171|3.14.6,800-171|3.14.7,800-53|RA-5,800-53|SI-3,800-53|SI-4,800-53r5|RA-5,800-53r5|SI-3,800-53r5|SI-4,CN-L3|7.1.3.5(a),CN-L3|7.1.3.6(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CSCv7|3.1,CSCv8|7.5,CSCv8|10.1,CSCv8|13.2,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-4,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.CM-8,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|PR.IP-12,CSF|RS.AN-1,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.12.2.1,ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SI-3,ITSG-33|SI-4,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|GS8a,PCI-DSSv3.2.1|5.1,PCI-DSSv3.2.1|5.1.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|5.2.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "3.1.3.4 Ensure that 'Agentless scanning for machines' component status is set to 'On'"
  info        : "Using disk snapshots, the agentless scanner scans for installed software, vulnerabilities, and plain text secrets.

Rationale:

The Microsoft Defender for Cloud agentless machine scanner provides threat detection, vulnerability detection, and discovery of sensitive information.

Impact:

Agentless scanning for machines requires licensing and is included in these plans:

Defender CSPM

Defender for Servers plan 2

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Audit from Azure Portal

From the Azure Portal Home page, select Microsoft Defender for Cloud

Under Management select Environment Settings

Select a subscription

Under Settings > Defender Plans, click Settings & monitoring

Under the Component column, locate the row for Agentless scanning for machines

Select On

Click Continue in the top left

Repeat the above for any additional subscriptions.

Default Value:

By default, Agentless scanning for machines is off."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "3.1.3.5 Ensure that 'File Integrity Monitoring' component status is set to 'On'"
  info        : "File Integrity Monitoring (FIM) is a feature that monitors critical system files in Windows or Linux for potential signs of attack or compromise.

Rationale:

FIM provides a detection mechanism for compromised files. When FIM is enabled, critical system files are monitored for changes that might indicate a threat actor is attempting to modify system files for lateral compromise within a host operating system.

Impact:

File Integrity Monitoring requires licensing and is included in these plans:

Defender for Servers plan 2

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Audit from Azure Portal

From the Azure Portal Home page, select Microsoft Defender for Cloud

Under Management select Environment Settings

Select a subscription

Under Settings > Defender Plans, click Settings & monitoring

Under the Component column, locate the row for File Integrity Monitoring

Select On

Click Continue in the top left

Repeat the above for any additional subscriptions.

Default Value:

By default, File Integrity Monitoring is Off."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "3.1.4.1 Ensure That Microsoft Defender for Containers Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Containers enables threat detection for Container Registries including Kubernetes, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud. The following services will be enabled for container instances:

Defender agent in Azure

Azure Policy for Kubernetes

Agentless discovery for Kubernetes

Agentless container vulnerability assessment

Rationale:

Enabling Microsoft Defender for Container Registries allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC).

Impact:

Turning on Microsoft Defender for Containers incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select Defender plans.

Set Status to On for Containers.

Click Save.

Remediate from Azure CLI
(Note: 'ContainerRegistry' has been deprecated and is replaced by 'Containers')
Use the below command to enable Standard pricing tier for Containers.

az security pricing create -n 'Containers' --tier 'standard'

Remediate from PowerShell
(Note: 'ContainerRegistry' has been deprecated and is replaced by 'Containers')
Use the below command to enable Standard pricing tier for Containers.

Set-AzSecurityPricing -Name 'Containers' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender for Containers is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "Containers") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: Containers, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "3.1.4.2 Ensure that 'Agentless discovery for Kubernetes' component status 'On'"
  info        : "Enable automatic discovery and configuration scanning of the Microsoft Kubernetes clusters.

Rationale:

As with any compute resource, Container environments require hardening and run-time protection to ensure safe operations and detection of threats and vulnerabilities.

Impact:

Agentless discovery for Kubernetes requires licensing and is included in:

Defender CSPM

Defender for Containers plans.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Audit from Azure Portal

From the Azure Portal Home page, select Microsoft Defender for Cloud

Under Management select Environment Settings

Select a subscription

Under Settings > Defender Plans, click Settings & monitoring

Locate the row for Agentless discovery for Kubernetes

Select On

Click Continue in the top left

Repeat the above for any additional subscriptions.

Default Value:

By default, Microsoft Defender for Containers is Off. If Defender for Containers is enabled from the Microsoft Defender for Cloud portal, auto provisioning will be enabled."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "3.1.4.3 Ensure that 'Agentless container vulnerability assessment' component status is 'On'"
  info        : "Enable automatic vulnerability management for images stored in ACR or running in AKS clusters.

Rationale:

Agentless vulnerability scanning will examine container images - whether running or in storage - for vulnerable configurations.

Impact:

Agentless container vulnerability assessment requires licensing and is included in:

Defender CSPM

Defender for Containers plans.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Audit from Azure Portal

From the Azure Portal Home page, select Microsoft Defender for Cloud

Under Management select Environment Settings

Select a subscription

Under Settings > Defender Plans, click Settings & monitoring

Locate the row for Agentless container vulnerability assessment

Select On

Click Continue in the top left

Repeat the above for any additional subscriptions.

Default Value:

By default, Microsoft Defender for Containers is Off. If Defender for Containers is enabled from the Microsoft Defender for Cloud portal, auto provisioning will be enabled."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "3.1.5.1 Ensure That Microsoft Defender for Storage Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Storage enables threat detection for Storage, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for Storage allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC).

Impact:

Turning on Microsoft Defender for Storage incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Set Status to On for Storage.

Select Save.

Remediate from Azure CLI
Ensure the output of the below command is Standard

az security pricing create -n StorageAccounts --tier 'standard'

Remediate from PowerShell

Set-AzSecurityPricing -Name 'StorageAccounts' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "StorageAccounts") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: StorageAccounts, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.6.1 Ensure That Microsoft Defender for App Services Is Set To 'On'"
  info           : "Turning on Microsoft Defender for App Service enables threat detection for App Service, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for App Service allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC).

Impact:

Turning on Microsoft Defender for App Service incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud

Under Management, select Environment Settings

Click on the subscription name

Select Defender plans

Set App Service Status to On

Select Save

Remediate from Azure CLI
Run the following command:

az security pricing create -n Appservices --tier 'standard'

Remediate from PowerShell
Run the following command:

Set-AzSecurityPricing -Name 'AppServices' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|7.6,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "AppServices") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: AppServices, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.7.1 Ensure That Microsoft Defender for Azure Cosmos DB Is Set To 'On'"
  info           : "Microsoft Defender for Azure Cosmos DB scans all incoming network requests for threats to your Azure Cosmos DB resources.

Rationale:

In scanning Azure Cosmos DB requests within a subscription, requests are compared to a heuristic list of potential security threats. These threats could be a result of a security breach within your services, thus scanning for them could prevent a potential security threat from being introduced.

Impact:

Enabling Microsoft Defender for Azure Cosmos DB requires enabling Microsoft Defender for your subscription. Both will incur additional charges."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

On the Database row click on Select types >.

Set the toggle switch next to Azure Cosmos DB to On.

Click Continue.

Click Save.

Remediate from Azure CLI
Run the following command:

az security pricing create -n 'CosmosDbs' --tier 'standard'

Remediate from PowerShell
Use the below command to enable Standard pricing tier for Azure Cosmos DB

Set-AzSecurityPricing -Name 'CosmosDbs' -PricingTier 'Standard

Default Value:

By default, Microsoft Defender for Azure Cosmos DB is not enabled."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "CosmosDbs") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: CosmosDbs, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.7.2 Ensure That Microsoft Defender for Open-Source Relational Databases Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Open-source relational databases enables threat detection for Open-source relational databases, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for Open-source relational databases allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC).

Impact:

Turning on Microsoft Defender for Open-source relational databases incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Click Select types > in the row for Databases.

Set the toggle switch next to Open-source relational databases to On.

Select Continue.

Select Save.

Remediate from Azure CLI
Run the following command:

az security pricing create -n 'OpenSourceRelationalDatabases' --tier 'standard'

Remediate from PowerShell
Use the below command to enable Standard pricing tier for Open-source relational databases

set-azsecuritypricing -name 'OpenSourceRelationalDatabases' -pricingtier 'Standard'

Default Value:

By default, Microsoft Defender plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "OpenSourceRelationalDatabases") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: OpenSourceRelationalDatabases, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.7.3 Ensure That Microsoft Defender for (Managed Instance) Azure SQL Databases Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Azure SQL Databases enables threat detection for Managed Instance Azure SQL databases, providing threat intelligence, anomaly detection, and behavior analytics in Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for Azure SQL Databases allows for greater defense-in-depth, includes functionality for discovering and classifying sensitive data, surfacing and mitigating potential database vulnerabilities, and detecting anomalous activities that could indicate a threat to your database.

Impact:

Turning on Microsoft Defender for Azure SQL Databases incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Click Select types > in the row for Databases.

Set the toggle switch next to Azure SQL Databases to On.

Select Continue.

Select Save.

Remediate from Azure CLI
Run the following command:

az security pricing create -n SqlServers --tier 'standard'

Remediate from PowerShell
Run the following command:

Set-AzSecurityPricing -Name 'SqlServers' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "SqlServers") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: SqlServers, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.7.4 Ensure That Microsoft Defender for SQL Servers on Machines Is Set To 'On'"
  info           : "Turning on Microsoft Defender for SQL servers on machines enables threat detection for SQL servers on machines, providing threat intelligence, anomaly detection, and behavior analytics in Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for SQL servers on machines allows for greater defense-in-depth, functionality for discovering and classifying sensitive data, surfacing and mitigating potential database vulnerabilities, and detecting anomalous activities that could indicate a threat to your database.

Impact:

Turning on Microsoft Defender for SQL servers on machines incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Click Select types > in the row for Databases.

Set the toggle switch next to SQL servers on machines to On.

Select Continue.

Select Save.

Remediate from Azure CLI
Run the following command:

az security pricing create -n SqlServerVirtualMachines --tier 'standard'

Remediate from PowerShell
Run the following command:

Set-AzSecurityPricing -Name 'SqlServerVirtualMachines' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53|SA-15,800-53r5|RA-5,800-53r5|SA-15,CSCv7|3.1,CSCv8|7.5,CSCv8|16.11,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-2,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|ID.RA-09,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|SS5,NIAv2|SS6a,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "SqlServerVirtualMachines") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: SqlServerVirtualMachines, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.8.1 Ensure That Microsoft Defender for Key Vault Is Set To 'On'"
  info           : "Turning on Microsoft Defender for Key Vault enables threat detection for Key Vault, providing threat intelligence, anomaly detection, and behavior analytics in the Microsoft Defender for Cloud.

Rationale:

Enabling Microsoft Defender for Key Vault allows for greater defense-in-depth, with threat detection provided by the Microsoft Security Response Center (MSRC).

Impact:

Turning on Microsoft Defender for Key Vault incurs an additional cost per resource."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Select On under Status for Key Vault.

Select Save.

Remediate from Azure CLI
Enable Standard pricing tier for Key Vault:

az security pricing create -n 'KeyVaults' --tier 'Standard'

Remediate from PowerShell
Enable Standard pricing tier for Key Vault:

Set-AzSecurityPricing -Name 'KeyVaults' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender plan is off."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "KeyVaults") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: KeyVaults, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.1.9.1 Ensure That Microsoft Defender for Resource Manager Is Set To 'On'"
  info           : "Microsoft Defender for Resource Manager scans incoming administrative requests to change your infrastructure from both CLI and the Azure portal.

Rationale:

Scanning resource requests lets you be alerted every time there is suspicious activity in order to prevent a security threat from being introduced.

Impact:

Enabling Microsoft Defender for Resource Manager requires enabling Microsoft Defender for your subscription. Both will incur additional charges."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Select On under Status for Resource Manager.

Select 'Save.

Remediate from Azure CLI
Use the below command to enable Standard pricing tier for Defender for Resource Manager

az security pricing create -n 'Arm' --tier 'Standard'

Remediate from PowerShell
Use the below command to enable Standard pricing tier for Defender for Resource Manager

Set-AzSecurityPricing -Name 'Arm' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender for Resource Manager is not enabled."
  reference      : "800-171|3.1.5,800-171|3.1.6,800-171|3.11.2,800-171|3.11.3,800-53|AC-6(2),800-53|AC-6(5),800-53|RA-5,800-53r5|AC-6(2),800-53r5|AC-6(5),800-53r5|RA-5,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.10.6(a),CSCv7|3.1,CSCv8|5.4,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.AC-4,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.AA-05,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO/IEC-27001|A.9.2.3,ISO/IEC-27001|A.12.6.1,ITSG-33|AC-6(2),ITSG-33|AC-6(5),ITSG-33|RA-5,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.6.1,NESA|T7.7.1,NIAv2|AM1,NIAv2|AM23f,NIAv2|AM32,NIAv2|AM33,NIAv2|SS13c,NIAv2|SS15c,NIAv2|VL3a,PCI-DSSv3.2.1|6.1,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|1.2,SWIFT-CSCv1|2.7,SWIFT-CSCv1|5.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "Arm") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: Arm, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "3.1.15 Ensure that Microsoft Defender External Attack Surface Monitoring (EASM) is enabled"
  info        : "An organization's attack surface is the collection of assets with a public network identifier or URI that an external threat actor can see or access from outside your cloud. It is the set of points on the boundary of a system, a system element, system component, or an environment where an attacker can try to enter, cause an effect on, or extract data from, that system, system element, system component, or environment. The larger the attack surface, the harder it is to protect.

This tool can be configured to scan your organization's online infrastructure such as specified domains, hosts, CIDR blocks, and SSL certificates, and store them in an Inventory. Inventory items can be added, reviewed, approved, and removed, and may contain enrichments ('insights') and additional information collected from the tool's different scan engines and open-source intelligence sources.

A Defender EASM workspace will generate an Inventory of publicly exposed assets by crawling and scanning the internet using Seeds you provide when setting up the tool. Seeds can be FQDNs, IP CIDR blocks, and WHOIS records.

Defender EASM will generate Insights within 24-48 hours after Seeds are provided, and these insights include vulnerability data (CVEs), ports and protocols, and weak or expired SSL certificates that could be used by an attacker for reconnaisance or exploitation.

Results are classified High/Medium/Low and some of them include proposed mitigations.

Rationale:

This tool can monitor the externally exposed resources of an organization, provide valuable insights, and export these findings in a variety of formats (including CSV) for use in vulnerability management operations and red/purple team exercises.

Impact:

Microsoft Defender EASM workspaces are currently available as Azure Resources with a 30-day free trial period but can quickly accrue significant charges. The costs are calculated daily as (Number of 'billable' inventory items) x (item cost per day; approximately: $0.017).

Estimated cost is not provided within the tool, and users are strongly advised to contact their Microsoft sales representative for pricing and set a calendar reminder for the end of the trial period.

For an EASM workspace having an Inventory of 5k-10k billable items (IP addresses, hostnames, SSL certificates, etc) a typical cost might be approximately $85-170 per day or $2500-5000 USD/month at the time of publication.

If the workspace is deleted by the last day of a free trial period, no charges are billed.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "To begin remediation, a Microsoft Defender EASM workspace must be created. The resources and inventory items added to this workspace will depend on your environment.

Default Value:

Microsoft Defender EASM is an optional, paid Azure Resource that must be created and configured inside a Subscription and Resource Group."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53r5|RA-5,CSCv7|3.1,CSCv8|7.6,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "3.1.16 [LEGACY] Ensure That Microsoft Defender for DNS Is Set To 'On'"
  info           : "[NOTE: As of August 1, 2023 customers with an existing subscription to Defender for DNS can continue to use the service, but new subscribers will receive alerts about suspicious DNS activity as part of Defender for Servers P2.]

Microsoft Defender for DNS scans all network traffic exiting from within a subscription.

Rationale:

DNS lookups within a subscription are scanned and compared to a dynamic list of websites that might be potential security threats. These threats could be a result of a security breach within your services, thus scanning for them could prevent a potential security threat from being introduced.

Impact:

Enabling Microsoft Defender for DNS requires enabling Microsoft Defender for your subscription. Both will incur additional charges, with Defender for DNS being a small amount per million queries."
  solution       : "Remediate from Azure Portal

Go to Microsoft Defender for Cloud.

Under Management, select Environment Settings.

Click on the subscription name.

Select the Defender plans blade.

Select On under Status for DNS.

Select Save.

Remediate from Azure CLI
Enable Standard pricing tier for DNS:

az security pricing create -n 'DNS' --tier 'Standard'

Remediate from PowerShell
Enable Standard pricing tier for DNS:

Set-AzSecurityPricing -Name 'DNS' -PricingTier 'Standard'

Default Value:

By default, Microsoft Defender for DNS is not enabled."
  reference      : "800-171|3.11.2,800-171|3.11.3,800-53|RA-5,800-53|SC-20,800-53|SC-21,800-53|SC-22,800-53r5|RA-5,800-53r5|SC-20,800-53r5|SC-21,800-53r5|SC-22,CSCv7|3.1,CSCv7|7.6,CSCv8|4.9,CSCv8|7.5,CSF|DE.CM-8,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.IP-12,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SC-20,ITSG-33|SC-21,ITSG-33|SC-21a.,ITSG-33|SC-22,ITSG-33|SC-22a.,LEVEL|2A,NESA|M1.2.2,NESA|M5.4.1,NESA|T4.5.1,NESA|T7.7.1,NIAv2|NS17,NIAv2|NS18,NIAv2|NS19,NIAv2|NS20,NIAv2|NS21,NIAv2|NS22,NIAv2|NS23,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listPricings"
  json_transform : '.[]|.subscriptionId as $id| .value[]| select(.name == "Dns") | "Subscription ID: \($id), Name: \(.name), Pricing Tier: \(.properties.pricingTier)"'
  expect         : "Name: Dns, Pricing Tier: Standard"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "3.2.1 Ensure That Microsoft Defender for IoT Hub Is Set To 'On'"
  info        : "Microsoft Defender for IoT acts as a central security hub for IoT devices within your organization.

Rationale:

IoT devices are very rarely patched and can be potential attack vectors for enterprise networks. Updating their network configuration to use a central security hub allows for detection of these breaches.

Impact:

Enabling Microsoft Defender for IoT will incur additional charges dependent on the level of usage.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Go to IoT Hub.

Select a IoT Hub to validate.

Select Overview in Defender for IoT.

Click on Secure your IoT solution, and complete the onboarding.

Default Value:

By default, Microsoft Defender for IoT is not enabled."
  reference   : "800-171|3.11.2,800-171|3.11.3,800-171|3.14.6,800-171|3.14.7,800-53|RA-5,800-53|SI-4,800-53|SI-4(4),800-53r5|RA-5,800-53r5|SI-4,800-53r5|SI-4(4),CN-L3|7.1.2.2(c),CN-L3|7.1.3.5(a),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CSCv7|3.1,CSCv8|7.5,CSCv8|13.6,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.CM-8,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|PR.IP-12,CSF|RS.AN-1,CSF|RS.CO-3,CSF|RS.MI-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|GV.SC-10,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|ID.RA-08,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,GDPR|32.1.d,HIPAA|164.306(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.12.6.1,ITSG-33|RA-5,ITSG-33|SI-4,ITSG-33|SI-4(4),LEVEL|2M,NESA|M1.2.2,NESA|M5.4.1,NESA|T7.7.1,NIAv2|NS32,PCI-DSSv3.2.1|6.1,PCI-DSSv4.0|6.3,PCI-DSSv4.0|6.3.1,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|2.7,SWIFT-CSCv1|6.5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "3.3.6 Enable Role Based Access Control for Azure Key Vault"
  info           : "The recommended way to access Key Vaults is to use the Azure Role-Based Access Control (RBAC) permissions model.

Azure RBAC is an authorization system built on Azure Resource Manager that provides fine-grained access management of Azure resources. It allows users to manage Key, Secret, and Certificate permissions. It provides one place to manage all permissions across all key vaults.

Rationale:

The new RBAC permissions model for Key Vaults enables a much finer grained access control for key vault secrets, keys, certificates, etc., than the vault access policy. This in turn will permit the use of privileged identity management over these roles, thus securing the key vaults with JIT Access management.

Impact:

Implementation needs to be properly designed from the ground up, as this is a fundamental change to the way key vaults are accessed/managed. Changing permissions to key vaults will result in loss of service as permissions are re-applied. For the least amount of downtime, map your current groups and users to their corresponding permission needs."
  solution       : "Remediate from Azure Portal
Key Vaults can be configured to use Azure role-based access control on creation.
For existing Key Vaults:

From Azure Home open the Portal Menu in the top left corner

Select Key Vaults

Select a Key Vault to audit

Select Access configuration

Set the Permission model radio button to Azure role-based access control, taking note of the warning message

Click Save

Select Access Control (IAM)

Select the Role Assignments tab

Reapply permissions as needed to groups or users

Remediate from Azure CLI
To enable RBAC Authorization for each Key Vault, run the following Azure CLI command:

az keyvault update --resource-group <resource_group> --name <vault_name> --enable-rbac-authorization true

Remediate from PowerShell
To enable RBAC authorization on each Key Vault, run the following PowerShell command:

Update-AzKeyVault -ResourceGroupName <resource_group> -VaultName <vault_name> -EnableRbacAuthorization $True

Default Value:

The default value for Access control in Key Vaults is Vault Policy."
  reference      : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.3.8,800-171|3.3.9,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-53|AC-2,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-6(1),800-53|AC-6(7),800-53|AU-9(4),800-53|MP-2,800-53r5|AC-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-6(1),800-53r5|AC-6(7),800-53r5|AU-9(4),800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(d),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.3(d),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSCv8|6.8,CSF|DE.CM-1,CSF|DE.CM-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-1,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.2.1,ISO/IEC-27001|A.9.2.5,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.4,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.12.4.2,ITSG-33|AC-2,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-6(1),ITSG-33|AU-9(4),ITSG-33|AU-9(4)(a),ITSG-33|AU-9(4)(b),ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2A,NESA|M1.1.3,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.5.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|AM28,NIAv2|AM31,NIAv2|GS3,NIAv2|GS4,NIAv2|GS8c,NIAv2|NS5j,NIAv2|SM5,NIAv2|SM6,NIAv2|SS13c,NIAv2|SS14e,NIAv2|SS15c,NIAv2|SS29,NIAv2|VL3b,PCI-DSSv3.2.1|7.1.2,PCI-DSSv3.2.1|10.5,PCI-DSSv3.2.1|10.5.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,PCI-DSSv4.0|10.3.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listVaultsByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|select(.properties != null)|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name), Enable RBAC Authorization: \(.properties.enableRbacAuthorization)"'
  expect         : "Enable RBAC Authorization: true"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "3.3.7 Ensure that Private Endpoints are Used for Azure Key Vault"
  info           : "Private endpoints will secure network traffic from Azure Key Vault to the resources requesting secrets and keys.

Rationale:

Private endpoints will keep network requests to Azure Key Vault limited to the endpoints attached to the resources that are whitelisted to communicate with each other. Assigning the Key Vault to a network without an endpoint will allow other resources on that network to view all traffic from the Key Vault to its destination. In spite of the complexity in configuration, this is recommended for high security secrets.

Impact:

Incorrect or poorly-timed changing of network configuration could result in service interruption. There are also additional costs tiers for running a private endpoint per petabyte or more of networking traffic."
  solution       : "Please see the additional information about the requirements needed before starting this remediation procedure.
Remediate from Azure Portal

From Azure Home open the Portal Menu in the top left.

Select Key Vaults.

Select a Key Vault to audit.

Select Networking in the left column.

Select Private endpoint connections from the top row.

Select + Create.

Select the subscription the Key Vault is within, and other desired configuration.

Select Next.

For resource type select Microsoft.KeyVault/vaults.

Select the Key Vault to associate the Private Endpoint with.

Select Next.

In the Virtual Networking field, select the network to assign the Endpoint.

Select other configuration options as desired, including an existing or new application security group.

Select Next.

Select the private DNS the Private Endpoints will use.

Select Next.

Optionally add Tags.

Select Next : Review + Create.

Review the information and select Create. Follow the Audit Procedure to determine if it has successfully applied.

Repeat steps 3-19 for each Key Vault.

Remediate from Azure CLI

To create an endpoint, run the following command:

az network private-endpoint create --resource-group <resourceGroup --vnet-name <vnetName> --subnet <subnetName> --name <PrivateEndpointName>  --private-connection-resource-id '/subscriptions/<AZURE SUBSCRIPTION ID>/resourceGroups/<resourceGroup>/providers/Microsoft.KeyVault/vaults/<keyVaultName>' --group-ids vault --connection-name <privateLinkConnectionName> --location <azureRegion> --manual-request

To manually approve the endpoint request, run the following command:

az keyvault private-endpoint-connection approve --resource-group <resourceGroup> --vault-name <keyVaultName> -name <privateLinkName>

Determine the Private Endpoint's IP address to connect the Key Vault to the Private DNS you have previously created:

Look for the property networkInterfaces then id; the value must be placed in the variable <privateEndpointNIC> within step 7.

az network private-endpoint show -g <resourceGroupName> -n <privateEndpointName>

Look for the property networkInterfaces then id; the value must be placed on <privateEndpointNIC> in step 7.

az network nic show --ids <privateEndpointName>

Create a Private DNS record within the DNS Zone you created for the Private Endpoint:

az network private-dns record-set a add-record -g <resourcecGroupName> -z 'privatelink.vaultcore.azure.net' -n <keyVaultName> -a <privateEndpointNIC>

nslookup the private endpoint to determine if the DNS record is correct:

nslookup <keyVaultName>.vault.azure.net
nslookup <keyVaultName>.privatelink.vaultcore.azure.n

Default Value:

By default, Private Endpoints are not enabled for any services within Azure."
  reference      : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|14.1,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listVaultsByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|select(.properties != null)|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name), Private Endpoint Connections: \(.properties.privateEndpointConnections | length)"'
  not_expect     : "Private Endpoint Connections: 0"
</custom_item>

<custom_item>
  description    : "3.3.8 Ensure Automatic Key Rotation is Enabled Within Azure Key Vault for the Supported Services"
  info           : "Automatic Key Rotation is available in Public Preview. The currently supported applications are Key Vault, Managed Disks, and Storage accounts accessing keys within Key Vault. The number of supported applications will incrementally increased.

Rationale:

Once set up, Automatic Private Key Rotation removes the need for manual administration when keys expire at intervals determined by your organization's policy. The recommended key lifetime is 2 years. Your organization should determine its own key expiration policy.

Impact:

There are an additional costs per operation in running the needed applications.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Note: Azure CLI and Powershell use ISO8601 flags to input timespans. Every timespan input will be in the format P<timespanInISO8601Format>(Y,M,D). The leading P is required with it denoting period. The (Y,M,D) are for the duration of Year, Month,and Day respectively. A time frame of 2 years, 2 months, 2 days would be (P2Y2M2D).

Remediate from Azure Portal

From Azure Portal select the Portal Menu in the top left.

Select Key Vaults.

Select a Key Vault to audit.

Under Objects select Keys.

Select a key to audit.

In the top row select Rotation policy.

Select an Expiry time.

Set Enable auto rotation to Enabled.

Set an appropriate Rotation option and Rotation time.

Optionally set the Notification time.

Select Save.

Repeat steps 3-11 for each Key Vault and Key.

Remediate from Azure CLI
Run the following command for each key to update its policy to be auto-rotated:

az keyvault key rotation-policy update -n <keyName> --vault-name <vaultName> --value <path/to/policy.json>

Note: It is easiest to supply the policy flags in a .json file. An example json file would be:

{
  'lifetimeActions': [
    {
      'trigger': {
        'timeAfterCreate': '<timespanInISO8601Format>',
        'timeBeforeExpiry' : null
      },
      'action': {
        'type': 'Rotate'
      }
    },
    {
      'trigger': {
        'timeBeforeExpiry' : '<timespanInISO8601Format>'
      },
      'action': {
        'type': 'Notify'
      }
    }
  ],
  'attributes': {
    'expiryTime': '<timespanInISO8601Format>'
  }
}

Remediate from PowerShell
Run the following command for each key to update its policy:

Set-AzKeyVaultKeyRotationPolicy -VaultName test-kv -Name test-key -PolicyPath rotation_policy.json

Note: It is easiest to supply the policy flags in a .json file. An example json file would be:

<#
rotation_policy.json
{
    'lifetimeActions': [
      {
        'trigger': {
          'timeAfterCreate': 'P<timespanInISO8601Format>M',
          'timeBeforeExpiry': null
        },
        'action': {
          'type': 'Rotate'
        }
      },
      {
        'trigger': {
          'timeBeforeExpiry': 'P<timespanInISO8601Format>D'
        },
        'action': {
          'type': 'Notify'
        }
      }
    ],
    'attributes': {
      'expiryTime': 'P<timespanInISO8601Format>Y'
    }
  }
#>

Default Value:

By default, Automatic Key Rotation is not enabled."
  reference      : "800-171|3.1.1,800-53|AC-1,800-53|AC-2,800-53|AC-2(1),800-53|AU-11,800-53|SI-12,800-53r5|AC-1,800-53r5|AC-2,800-53r5|AC-2(1),800-53r5|AU-11,800-53r5|CM-12,800-53r5|SI-12,CN-L3|7.1.3.2(d),CN-L3|8.1.4.2(e),CN-L3|8.1.10.6(c),CSCv7|16.7,CSCv8|3.1,CSCv8|6.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|ID.GV-1,CSF|ID.GV-3,CSF|PR.AC-1,CSF|PR.AC-4,CSF|PR.PT-1,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|GV.OC-03,CSF2.0|GV.OV-01,CSF2.0|GV.PO-01,CSF2.0|GV.PO-02,CSF2.0|GV.SC-03,CSF2.0|ID.AM-07,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.AA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.9.1.1,ISO/IEC-27001|A.9.2.1,ITSG-33|AC-1,ITSG-33|AC-2,ITSG-33|AC-2(1),ITSG-33|AU-11,ITSG-33|SI-12,ITSG-33|SI-12a.,LEVEL|2A,NESA|M1.2.2,NESA|M5.2.3,NESA|M5.2.4,NESA|M5.3.1,NESA|T3.6.2,NIAv2|AM28,NIAv2|AM29,NIAv2|AM30,NIAv2|DR1,NIAv2|DR1a,NIAv2|DR1b,NIAv2|DR1c,NIAv2|DR2,NIAv2|DR3,NIAv2|DR4,NIAv2|DR5,NIAv2|DR6,NIAv2|NS5j,NIAv2|SM7,NIAv2|SS14e,PCI-DSSv3.2.1|3.1,PCI-DSSv3.2.1|10.7,PCI-DSSv4.0|3.2.1,PCI-DSSv4.0|10.5.1,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|8.2.1,QCSC-v1|13.2,QCSC-v1|15.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listVaultsByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgn|.vaults[]|"Subscription ID: \($subid), Resource Group: \($rgn), Vault Name: \(.name)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "4.2 Ensure that 'Enable Infrastructure Encryption' for Each Storage Account in Azure Storage is Set to 'enabled'"
  info           : "Enabling encryption at the hardware level on top of the default software encryption for Storage Accounts accessing Azure storage solutions.

Rationale:

Azure Storage automatically encrypts all data in a storage account at the network level using 256-bit AES encryption, which is one of the strongest, FIPS 140-2-compliant block ciphers available. Customers who require higher levels of assurance that their data is secure can also enable 256-bit AES encryption at the Azure Storage infrastructure level for double encryption. Double encryption of Azure Storage data protects against a scenario where one of the encryption algorithms or keys may be compromised. Similarly, data is encrypted even before network transmission and in all backups. In this scenario, the additional layer of encryption continues to protect your data. For the most secure implementation of key based encryption, it is recommended to use a Customer Managed asymmetric RSA 2048 Key in Azure Key Vault.

Impact:

The read and write speeds to the storage will be impacted if both default encryption and Infrastructure Encryption are checked, as a secondary form of encryption requires more resource overhead for the cryptography of information. This performance impact should be considered in an analysis for justifying use of the feature in your environment. Customer-managed keys are recommended for the most secure implementation, leading to overhead of key management. The key will also need to be backed up in a secure location, as loss of the key will mean loss of the information in the storage."
  solution       : "Remediate from Azure Portal

During Storage Account creation, in the Encryption tab, check the box next to Enable infrastructure encryption.

Remediate from Azure CLI
Replace the information within <> with appropriate values:

az storage account create \
    --name <storage-account> \
    --resource-group <resource-group> \
    --location <location> \
    --sku Standard_RAGRS \
    --kind StorageV2 \
    --require-infrastructure-encryption

Remediate from PowerShell
Replace the information within <> with appropriate values:

New-AzStorageAccount -ResourceGroupName <resource_group> '
    -AccountName <storage-account> '
    -Location <location> '
    -SkuName 'Standard_RAGRS' '
    -Kind StorageV2 '
    -RequireInfrastructureEncryption

Enabling Infrastructure Encryption after Storage Account Creation
If infrastructure encryption was not enabled on blob storage creation, there is no official way to enable it. Please see the additional information section.

Default Value:

By default, Infrastructure Encryption is disabled in blob creation."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Require Infrastructure Encryption: \(.properties.encryption.requireInfrastructureEncryption)"'
  expect         : "Require Infrastructure Encryption: true"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "4.8 Ensure 'Allow Azure services on the trusted services list to access this storage account' is Enabled for Storage Account Access"
  info           : "NOTE: This recommendation assumes that the Public network access parameter is set to Enabled from selected virtual networks and IP addresses. Please ensure the prerequisite recommendation has been implemented before proceeding:

Ensure Default Network Access Rule for Storage Accounts is Set to Deny

Some Azure services that interact with storage accounts operate from networks that can't be granted access through network rules. To help this type of service work as intended, allow the set of trusted Azure services to bypass the network rules. These services will then use strong authentication to access the storage account. If the Allow Azure services on the trusted services list to access this storage account exception is enabled, the following services are granted access to the storage account: Azure Backup, Azure Data Box, Azure DevTest Labs, Azure Event Grid, Azure Event Hubs, Azure File Sync, Azure HDInsight, Azure Import/Export, Azure Monitor, Azure Networking Services, and Azure Site Recovery (when registered in the subscription).

Rationale:

Turning on firewall rules for a storage account will block access to incoming requests for data, including from other Azure services. We can re-enable this functionality by allowing access to trusted Azure services through networking exceptions.

Impact:

This creates authentication credentials for services that need access to storage resources so that services will no longer need to communicate via network request. There may be a temporary loss of communication as you set each Storage Account. It is recommended to not do this on mission-critical resources during business hours."
  solution       : "Remediate from Azure Portal

Go to Storage Accounts.

For each storage account, under Security + networking, click Networking.

Click on the Firewalls and virtual networks heading.

Under Exceptions, check the box next to Allow Azure services on the trusted services list to access this storage account.

Click Save.

Remediate from Azure CLI
Use the below command to update bypass to Azure services.

az storage account update --name <StorageAccountName> --resource-group <resourceGroupName> --bypass AzureServices

Default Value:

By default, Storage Accounts will accept connections from clients on any network."
  reference      : "800-171|3.1.1,800-171|3.1.2,800-171|3.1.4,800-171|3.1.5,800-171|3.1.12,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-171|3.13.1,800-171|3.13.5,800-171|3.14.6,800-171|3.14.7,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|AC-17,800-53|AC-17(1),800-53|MP-2,800-53|SC-7,800-53|SI-4,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|AC-17,800-53r5|AC-17(1),800-53r5|MP-2,800-53r5|SC-7,800-53r5|SI-4,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|7.1.3.5(a),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.4(c),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(a),CN-L3|8.1.10.6(f),CN-L3|8.1.10.6(i),CN-L3|8.1.10.6(j),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|13.3,CSCv8|3.3,CSCv8|13.5,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.AC-3,CSF|PR.AC-4,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-8,CSF|PR.PT-2,CSF|PR.PT-3,CSF|PR.PT-4,CSF|RS.AN-1,CSF|RS.CO-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|PR.AA-05,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),HIPAA|164.312(b),ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.6.2.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ISO/IEC-27001|A.13.1.3,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|AC-17,ITSG-33|AC-17(1),ITSG-33|MP-2,ITSG-33|MP-2a.,ITSG-33|SC-7,ITSG-33|SI-4,LEVEL|2A,NESA|M1.2.2,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T4.5.4,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|2.6,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Bypass: \(.properties.networkAcls.bypass)"'
  expect         : "Bypass: .*AzureServices"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "4.9 Ensure Private Endpoints are used to access Storage Accounts"
  info           : "Use private endpoints for your Azure Storage accounts to allow clients and services to securely access data located over a network via an encrypted Private Link. To do this, the private endpoint uses an IP address from the VNet for each service. Network traffic between disparate services securely traverses encrypted over the VNet. This VNet can also link addressing space, extending your network and accessing resources on it. Similarly, it can be a tunnel through public networks to connect remote infrastructures together. This creates further security through segmenting network traffic and preventing outside sources from accessing it.

Rationale:

Securing traffic between services through encryption protects the data from easy interception and reading.

Impact:

A Private Endpoint costs approximately US$7.30 per month. If an Azure Virtual Network is not implemented correctly, this may result in the loss of critical network traffic."
  solution       : "Remediate from Azure Portal

Open the Storage Accounts blade

For each listed Storage Account, perform the following:

Under the Security + networking heading, click on Networking

Click on the Private endpoint connections tab at the top of the networking window

Click the + Private endpoint button

In the 1 - Basics tab/step:

Enter a name that will be easily recognizable as associated with the Storage Account (Note: The 'Network Interface Name' will be automatically completed, but you can customize it if needed.)

Ensure that the Region matches the region of the Storage Account

Click Next

In the 2 - Resource tab/step:

Select the target sub-resource based on what type of storage resource is being made available

Click Next

In the 3 - Virtual Network tab/step:

Select the Virtual network that your Storage Account will be connecting to

Select the Subnet that your Storage Account will be connecting to

(Optional) Select other network settings as appropriate for your environment

Click Next

In the 4 - DNS tab/step:

(Optional) Select other DNS settings as appropriate for your environment

Click Next

In the 5 - Tags tab/step:

(Optional) Set any tags that are relevant to your organization

Click Next

In the 6 - Review + create tab/step:

A validation attempt will be made and after a few moments it should indicate Validation Passed - if it does not pass, double-check your settings before beginning more in depth troubleshooting.

If validation has passed, click Create then wait for a few minutes for the scripted deployment to complete.

Repeat the above procedure for each Private Endpoint required within every Storage Account.

Remediate from PowerShell

$storageAccount = Get-AzStorageAccount -ResourceGroupName '<ResourceGroupName>' -Name '<storageaccountname>'


$privateEndpointConnection = @{
                                Name = 'connectionName'
                                PrivateLinkServiceId = $storageAccount.Id
                                GroupID = 'blob|blob_secondary|file|file_secondary|table|table_secondary|queue|queue_secondary|web|web_secondary|dfs|dfs_secondary'
}


$privateLinkServiceConnection = New-AzPrivateLinkServiceConnection @privateEndpointConnection


$virtualNetDetails = Get-AzVirtualNetwork -ResourceGroupName '<ResourceGroupName>' -Name '<name>'


$privateEndpoint = @{
                    ResourceGroupName = '<ResourceGroupName>'
                    Name = '<PrivateEndpointName>'
                    Location = '<location>'
                    Subnet = $virtualNetDetails.Subnets[0]
                    PrivateLinkServiceConnection = $privateLinkServiceConnection
}

New-AzPrivateEndpoint @privateEndpoint

Remediate from Azure CLI

az network private-endpoint create --resource-group <ResourceGroupName --location <location> --name <private endpoint name> --vnet-name <VNET Name> --subnet <subnet name> --private-connection-resource-id <storage account ID> --connection-name <private link service connection name> --group-id <blob|blob_secondary|file|file_secondary|table|table_secondary|queue|queue_secondary|web|web_secondary|dfs|dfs_secondary>

Default Value:

By default, Private Endpoints are not created for Storage Accounts."
  reference      : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|14.1,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Private Endpoint Connections: \(.properties.privateEndpointConnections | length > 0)"'
  not_expect     : "Private Endpoint Connections: false"
</custom_item>

<custom_item>
  description    : "4.11 Ensure Storage for Critical Data are Encrypted with Customer Managed Keys (CMK)"
  info           : "Enable sensitive data encryption at rest using Customer Managed Keys (CMK) rather than Microsoft Managed keys.

Rationale:

By default, data in the storage account is encrypted using Microsoft Managed Keys at rest. All Azure Storage resources are encrypted, including blobs, disks, files, queues, and tables. All object metadata is also encrypted. If you want to control and manage this encryption key yourself, however, you can specify a customer-managed key. That key is used to protect and control access to the key that encrypts your data. You can also choose to automatically update the key version used for Azure Storage encryption whenever a new version is available in the associated Key Vault.

While it is possible to automate the assessment of this recommendation, the assessment status for this recommendation remains 'Manual.' This is because the recommendation pertains to storage accounts that store critical data and is therefore not applicable to all storage accounts.

Impact:

If the key expires by setting the 'activation date' and 'expiration date', the user must rotate the key manually.

Using Customer Managed Keys may also incur additional man-hour requirements to create, store, manage, and protect the keys as needed."
  solution       : "Remediate from Azure Portal

Go to Storage Accounts

For each storage account, under Security + networking, go to Encryption

Set Encryption type to Customer-managed keys

Select an encryption key or enter a key URI

Click Save

Default Value:

By default, Encryption type is set to Microsoft Managed Keys."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2M,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Encryption Type: \(.properties.encryption.keySource)"'
  not_expect     : "Encryption Type: Microsoft\.Storage"
</custom_item>

<custom_item>
  description    : "4.12 Ensure Storage Logging is Enabled for Queue Service for 'Read', 'Write', and 'Delete' requests"
  info           : "The Storage Queue service stores messages that may be read by any client who has access to the storage account. A queue can contain an unlimited number of messages, each of which can be up to 64KB in size using version 2011-08-18 or newer. Storage Logging happens server-side and allows details for both successful and failed requests to be recorded in the storage account. These logs allow users to see the details of read, write, and delete operations against the queues. Storage Logging log entries contain the following information about individual requests: Timing information such as start time, end-to-end latency, and server latency, authentication details, concurrency information, and the sizes of the request and response messages.

Rationale:

Storage Analytics logs contain detailed information about successful and failed requests to a storage service. This information can be used to monitor individual requests and to diagnose issues with a storage service. Requests are logged on a best-effort basis.

Storage Analytics logging is not enabled by default for your storage account.

Impact:

Enabling this setting can have a high impact on the cost of the log analytics service and data storage used by logging more data per each request. Do not enable this without determining your need for this level of logging, and do not forget to check in on data usage and projected cost. Some users have seen their logging costs increase from $10 per month to $10,000 per month.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

Go to Storage Accounts.

For each storage account, under Monitoring, click Diagnostics settings.

Select the queue tab indented below the storage account.

To create a new diagnostic setting, click + Add diagnostic setting. To update an existing diagnostic setting, click Edit setting on the diagnostic setting.

Check the boxes next to StorageRead, StorageWrite, and StorageDelete.

Select an appropriate destination.

Click Save.

Remediate from Azure CLI
Use the below command to enable the Storage Logging for Queue service.

az storage logging update --account-name <storageAccountName> --account-key <storageAccountKey> --services q --log rwd --retention 90

Default Value:

By default storage account queue services are not logged."
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-53|AU-3,800-53|AU-3(1),800-53|AU-7,800-53|AU-12,800-53r5|AU-3,800-53r5|AU-3(1),800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(a),CN-L3|7.1.2.3(b),CN-L3|7.1.2.3(c),CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|8.1.4.3(b),CSCv7|6.3,CSCv8|8.5,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-3,ITSG-33|AU-3(1),ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|T3.6.2,NIAv2|AM34a,NIAv2|AM34b,NIAv2|AM34c,NIAv2|AM34d,NIAv2|AM34e,NIAv2|AM34f,NIAv2|AM34g,PCI-DSSv3.2.1|10.1,PCI-DSSv3.2.1|10.3,PCI-DSSv3.2.1|10.3.1,PCI-DSSv3.2.1|10.3.2,PCI-DSSv3.2.1|10.3.3,PCI-DSSv3.2.1|10.3.4,PCI-DSSv3.2.1|10.3.5,PCI-DSSv3.2.1|10.3.6,PCI-DSSv4.0|10.2.2,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id|.value[] | "Subscription ID: \($id), Name: \(.name)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "4.13 Ensure Storage logging is Enabled for Blob Service for 'Read', 'Write', and 'Delete' requests"
  info           : "The Storage Blob service provides scalable, cost-efficient object storage in the cloud. Storage Logging happens server-side and allows details for both successful and failed requests to be recorded in the storage account. These logs allow users to see the details of read, write, and delete operations against the blobs. Storage Logging log entries contain the following information about individual requests: timing information such as start time, end-to-end latency, and server latency; authentication details; concurrency information; and the sizes of the request and response messages.

Rationale:

Storage Analytics logs contain detailed information about successful and failed requests to a storage service. This information can be used to monitor each individual request to a storage service for increased security or diagnostics. Requests are logged on a best-effort basis.

Storage Analytics logging is not enabled by default for your storage account.

Impact:

Being a level 2, enabling this setting can have a high impact on the cost of data storage used for logging more data per each request. Do not enable this without determining your need for this level of logging or forget to check in on data usage and projected cost.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

Go to Storage Accounts.

For each storage account, under Monitoring, click Diagnostics settings.

Select the blob tab indented below the storage account.

To create a new diagnostic setting, click + Add diagnostic setting. To update an existing diagnostic setting, click Edit setting on the diagnostic setting.

Check the boxes next to StorageRead, StorageWrite, and StorageDelete.

Select an appropriate destination.

Click Save.

Remediate from Azure CLI
Use the below command to enable the Storage Logging for Blob service.

az storage logging update --account-name <storageAccountName> --account-key <storageAccountKey> --services b --log rwd --retention 90

Default Value:

By default, storage account blob service logging is disabled for read, write, and delete operations."
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-53|AU-3,800-53|AU-3(1),800-53|AU-7,800-53|AU-12,800-53r5|AU-3,800-53r5|AU-3(1),800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(a),CN-L3|7.1.2.3(b),CN-L3|7.1.2.3(c),CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|8.1.4.3(b),CSCv7|6.3,CSCv8|8.5,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-3,ITSG-33|AU-3(1),ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|T3.6.2,NIAv2|AM34a,NIAv2|AM34b,NIAv2|AM34c,NIAv2|AM34d,NIAv2|AM34e,NIAv2|AM34f,NIAv2|AM34g,PCI-DSSv3.2.1|10.1,PCI-DSSv3.2.1|10.3,PCI-DSSv3.2.1|10.3.1,PCI-DSSv3.2.1|10.3.2,PCI-DSSv3.2.1|10.3.3,PCI-DSSv3.2.1|10.3.4,PCI-DSSv3.2.1|10.3.5,PCI-DSSv3.2.1|10.3.6,PCI-DSSv4.0|10.2.2,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id|.value[] | "Subscription ID: \($id), Name: \(.name)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "4.14 Ensure Storage Logging is Enabled for Table Service for 'Read', 'Write', and 'Delete' Requests"
  info           : "Azure Table storage is a service that stores structured NoSQL data in the cloud, providing a key/attribute store with a schema-less design. Storage Logging happens server-side and allows details for both successful and failed requests to be recorded in the storage account. These logs allow users to see the details of read, write, and delete operations against the tables. Storage Logging log entries contain the following information about individual requests: timing information such as start time, end-to-end latency, and server latency; authentication details; concurrency information; and the sizes of the request and response messages.

Rationale:

Storage Analytics logs contain detailed information about successful and failed requests to a storage service. This information can be used to monitor each individual request to a storage service for increased security or diagnostics. Requests are logged on a best-effort basis.

Storage Analytics logging is not enabled by default for your storage account.

Impact:

Being a level 2, enabling this setting can have a high impact on the cost of data storage used for logging more data per each request. Do not enable this without determining your need for this level of logging or forget to check in on data usage and projected cost.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

Go to Storage Accounts.

For each storage account, under Monitoring, click Diagnostics settings.

Select the table tab indented below the storage account.

To create a new diagnostic setting, click + Add diagnostic setting. To update an existing diagnostic setting, click Edit setting on the diagnostic setting.

Check the boxes next to StorageRead, StorageWrite, and StorageDelete.

Select an appropriate destination.

Click Save.

Remediate from Azure CLI
Use the below command to enable the Storage Logging for Table service.

az storage logging update --account-name <storageAccountName> --account-key <storageAccountKey> --services t --log rwd --retention 90

Default Value:

By default, storage account table service logging is disabled for read, write, an delete operations"
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-53|AU-3,800-53|AU-3(1),800-53|AU-7,800-53|AU-12,800-53r5|AU-3,800-53r5|AU-3(1),800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(a),CN-L3|7.1.2.3(b),CN-L3|7.1.2.3(c),CN-L3|7.1.3.3(a),CN-L3|7.1.3.3(b),CN-L3|8.1.4.3(b),CSCv7|6.3,CSCv8|8.5,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-3,ITSG-33|AU-3(1),ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|T3.6.2,NIAv2|AM34a,NIAv2|AM34b,NIAv2|AM34c,NIAv2|AM34d,NIAv2|AM34e,NIAv2|AM34f,NIAv2|AM34g,PCI-DSSv3.2.1|10.1,PCI-DSSv3.2.1|10.3,PCI-DSSv3.2.1|10.3.1,PCI-DSSv3.2.1|10.3.2,PCI-DSSv3.2.1|10.3.3,PCI-DSSv3.2.1|10.3.4,PCI-DSSv3.2.1|10.3.5,PCI-DSSv3.2.1|10.3.6,PCI-DSSv4.0|10.2.2,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id|.value[] | "Subscription ID: \($id), Name: \(.name)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "5.1.3 Ensure SQL server's Transparent Data Encryption (TDE) protector is encrypted with Customer-managed key"
  info           : "Transparent Data Encryption (TDE) with Customer-managed key support provides increased transparency and control over the TDE Protector, increased security with an HSM-backed external service, and promotion of separation of duties.

With TDE, data is encrypted at rest with a symmetric key (called the database encryption key) stored in the database or data warehouse distribution. To protect this data encryption key (DEK) in the past, only a certificate that the Azure SQL Service managed could be used. Now, with Customer-managed key support for TDE, the DEK can be protected with an asymmetric key that is stored in the Azure Key Vault. The Azure Key Vault is a highly available and scalable cloud-based key store which offers central key management, leverages FIPS 140-2 Level 2 validated hardware security modules (HSMs), and allows separation of management of keys and data for additional security.

Based on business needs or criticality of data/databases hosted on a SQL server, it is recommended that the TDE protector is encrypted by a key that is managed by the data owner (Customer-managed key).

Rationale:

Customer-managed key support for Transparent Data Encryption (TDE) allows user control of TDE encryption keys and restricts who can access them and when. Azure Key Vault, Azure's cloud-based external key management system, is the first key management service where TDE has integrated support for Customer-managed keys. With Customer-managed key support, the database encryption key is protected by an asymmetric key stored in the Key Vault. The asymmetric key is set at the server level and inherited by all databases under that server.

Impact:

Once TDE protector is encrypted with a Customer-managed key, it transfers entire responsibility of respective key management on to you, and hence you should be more careful about doing any operations on the particular key in order to keep data from corresponding SQL server and Databases hosted accessible.

When deploying Customer Managed Keys, it is prudent to ensure that you also deploy an automated toolset for managing these keys (this should include discovery and key rotation), and Keys should be stored in an HSM or hardware backed keystore, such as Azure Key Vault.

As far as toolsets go, check with your cryptographic key provider, as they may well provide one as an add-on to their service."
  solution       : "Remediate from Azure Portal

Go to SQL servers

For each SQL server, under Security, click Transparent data encryption

Set Transparent data encryption to Customer-managed key

Select a key or enter a key identifier

Check Make this key the default TDE protector

Click Save

Remediate from Azure CLI
Use the below command to encrypt SQL server's TDE protector with a Customer-managed key

az sql server tde-key set --resource-group <resourceName> --server <dbServerName> --server-key-type {AzureKeyVault} --kid <keyIdentifier>

Remediate from PowerShell
Use the below command to encrypt SQL server's TDE protector with a Customer-managed Key Vault key

Set-AzSqlServerTransparentDataEncryptionProtector -Type AzureKeyVault -KeyId <KeyIdentifier> -ServerName <ServerName> -ResourceGroupName <ResourceGroupName>

Select Y when prompted

Default Value:

By Default, Microsoft managed TDE protector is enabled for a SQL server."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|16.4,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "getSQLServerEncryptionProtector"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.SQLServers[]|.name as $sname|"Subscription ID: \($subid), Resource Group: \($rgname), SQLServer: \($sname), Kind: \(.value[].kind), Server Key Type: \(.value[].properties.serverKeyType), URI: \(.value[].properties.uri)"'
  expect         : 'Kind: azurekeyvault, Server Key Type: AzureKeyVault, URI: (?!null)+'
  match_all      : YES
</custom_item>

<custom_item>
  description    : "5.3.3 Ensure server parameter 'audit_log_enabled' is set to 'ON' for MySQL flexible server"
  info           : "Enable audit_log_enabled on MySQL flexible servers.

Rationale:

Enabling audit_log_enabled helps MySQL Database to log items such as connection attempts to the server, DDL/DML access, and more. Log data can be used to identify, troubleshoot, and repair configuration errors and suboptimal performance.

Impact:

There are further costs incurred for storage of logs. For high traffic databases these logs will be significant. Determine your organization's needs before enabling."
  solution       : "Remediate from Azure Portal
Part 1 - Turn on audit logs

Login to Azure Portal using https://portal.azure.com.

Go to Azure Database for MySQL flexible servers.

For each database, under Settings, click Server parameters.

Set audit_log_enabled to ON.

Click Save.

Part 2 - Capture audit logs (diagnostic settings is for example only, send these logs to the appropriate data sink for your logging needs)

Under Monitoring, select Diagnostic settings.

Select + Add diagnostic setting.

Provide a diagnostic setting name.

Under Categories, select MySQL Audit Logs.

Specify destination details.

Click Save.

It may take up to 10 minutes for the logs to appear in the configured destination.

Remediate from Azure CLI
Use the below command to enable audit_log_enabled :

az mysql flexible-server parameter set --resource-group <resourceGroup> --server-name <serverName> --name audit_log_enabled --value on

Remediate from PowerShell
Use the below command to enable audit_log_enabled :

Update-AzMySqlFlexibleServerConfiguration -ResourceGroupName <resourceGroup> -ServerName <serverName> -Name audit_log_enabled -Value on

Default Value:

audit_log_enabled is set to OFF by default"
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listMYSQLFlexibleServersConfigurations"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname | .MYSQLFlexibleServers[] | .name as $name | .value[] | select(.name == "audit_log_enabled") |"Subscription ID: \($subid), Resource Group: \($rgname), MySQLServer: \($name), audit_log_enabled: \(.properties.value)"'
  expect         : "audit_log_enabled: ON"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "5.3.4 Ensure server parameter 'audit_log_events' has 'CONNECTION' set for MySQL flexible server"
  info           : "Set audit_log_events to include CONNECTION on MySQL flexible servers.

Rationale:

Enabling CONNECTION helps MySQL Database to log items such as successful and failed connection attempts to the server. Log data can be used to identify, troubleshoot, and repair configuration errors and suboptimal performance.

Impact:

There are further costs incurred for storage of logs. For high traffic databases these logs will be significant. Determine your organization's needs before enabling."
  solution       : "Remediate from Azure Portal

Login to Azure Portal using https://portal.azure.com.

Go to Azure Database for MySQL flexible servers.

For each database, under Settings, click Server parameters.

In the filter bar, type audit_log.

Set audit_log_enabled to ON.

In the drop-down next to audit_log_events, check CONNECTION.

Click Save.

Under Monitoring, select Diagnostic settings.

Select + Add diagnostic setting.

Provide a diagnostic setting name.

Under Categories, select MySQL Audit Logs.

Specify destination details.

Click Save.

It may take up to 10 minutes for the logs to appear in the configured destination.

Remediate from Azure CLI
Use the below command to set audit_log_events to CONNECTION:

az mysql flexible-server parameter set --resource-group <resourceGroup> --server-name <serverName> --name audit_log_events --value CONNECTION

Remediate from PowerShell
Use the below command to set audit_log_events to CONNECTION:

Update-AzMySqlFlexibleServerConfiguration -ResourceGroupName <resourceGroup> -ServerName <serverName> -Name audit_log_events -Value CONNECTION

Default Value:

By default audit_log_events is set to CONNECTION."
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listMYSQLFlexibleServersConfigurations"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname | .MYSQLFlexibleServers[] | .name as $name | .value[] | select(.name == "audit_log_events") |"Subscription ID: \($subid), Resource Group: \($rgname), MySQLServer: \($name), audit_log_events: \(.properties.value)"'
  expect         : "audit_log_events: .*CONNECTION"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "5.4.1 Ensure That 'Firewalls & Networks' Is Limited to Use Selected Networks Instead of All Networks"
  info           : "Limiting your Cosmos DB to only communicate on whitelisted networks lowers its attack footprint.

Rationale:

Selecting certain networks for your Cosmos DB to communicate restricts the number of networks including the internet that can interact with what is stored within the database.

Impact:

WARNING: Failure to whitelist the correct networks will result in a connection loss.

WARNING: Changes to Cosmos DB firewalls may take up to 15 minutes to apply. Ensure that sufficient time is planned for remediation or changes to avoid disruption."
  solution       : "Remediate from Azure Portal

Open the portal menu.

Select the Azure Cosmos DB blade.

Select a Cosmos DB account to audit.

Select Networking.

Under Public network access, select Selected networks.

Under Virtual networks, select + Add existing virtual network or + Add a new virtual network.

For existing networks, select subscription, virtual network, subnet and click Add. For new networks, provide a name, update the default values if required, and click Create.

Click Save.

Default Value:

By default, Cosmos DBs are set to have access all networks."
  reference      : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-171|3.13.6,800-53|CA-9,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53|SC-7(5),800-53r5|CA-9,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,800-53r5|SC-7(5),CN-L3|7.1.2.2(c),CN-L3|8.1.10.6(j),CSCv7|9.4,CSCv7|14.1,CSCv8|4.4,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,GDPR|32.2,HIPAA|164.306(a)(1),ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,ITSG-33|SC-7(5),LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|GS7b,NIAv2|NS25,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listCosmosDbAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Virtual Network Filter Enabled: \(.properties.isVirtualNetworkFilterEnabled)"'
  expect         : "Virtual Network Filter Enabled: true"
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "5.4.2 Ensure That Private Endpoints Are Used Where Possible"
  info        : "Private endpoints limit network traffic to approved sources.

Rationale:

For sensitive data, private endpoints allow granular control of which services can communicate with Cosmos DB and ensure that this network traffic is private. You set this up on a case by case basis for each service you wish to be connected.

Impact:

Only whitelisted services will have access to communicate with the Cosmos DB.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Open the portal menu.

Select the Azure Cosmos DB blade.

Select the Azure Cosmos DB account.

Select Networking.

Select Private access.

Click + Private Endpoint.

Provide a Name.

Click Next.

From the Resource type drop down, select Microsoft.AzureCosmosDB/databaseAccounts.

From the Resource drop down, select the Cosmos DB account.

Click Next.

Provide appropriate Virtual Network details.

Click Next.

Provide appropriate DNS details.

Click Next.

Optionally provide Tags.

Click Next : Review + create.

Click Create.

Default Value:

By default Cosmos DB does not have private endpoints enabled and its traffic is public to the network."
  reference   : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|14.1,CSCv8|12.2,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "6.1.3 Ensure the storage account containing the container with activity logs is encrypted with Customer Managed Key (CMK)"
  info           : "Storage accounts with the activity log exports can be configured to use Customer Managed Keys (CMK).

Rationale:

Configuring the storage account with the activity log export container to use CMKs provides additional confidentiality controls on log data, as a given user must have read permission on the corresponding storage account and must be granted decrypt permission by the CMK.

Impact:

NOTE: You must have your key vault setup to utilize this. All Audit Logs will be encrypted with a key you provide. You will need to set up customer managed keys separately, and you will select which key to use via the instructions here. You will be responsible for the lifecycle of the keys, and will need to manually replace them at your own determined intervals to keep the data secure.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

Go to Monitor.

Select Activity log.

Select Export Activity Logs.

Select a Subscription.

Note the name of the Storage Account for the diagnostic setting.

Navigate to Storage accounts.

Click on the storage account.

Under Security + networking, click Encryption.

Next to Encryption type, select Customer-managed keys.

Complete the steps to configure a customer-managed key for encryption of the storage account.

Remediate from Azure CLI

az storage account update --name <name of the storage account> --resource-group <resource group for a storage account> --encryption-key-source=Microsoft.Keyvault --encryption-key-vault <Key Vault URI> --encryption-key-name <KeyName> --encryption-key-version <Key Version>

Remediate from PowerShell

Set-AzStorageAccount -ResourceGroupName <resource group name> -Name <storage account name> -KeyvaultEncryption -KeyVaultUri <key vault URI> -KeyName <key name>

Default Value:

By default, for a storage account keySource is set to Microsoft.Storage allowing encryption with vendor Managed key and not a Customer Managed Key."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Key Vault Properties: \(.properties.encryption.keyVaultProperties), Encryption Type: \(.properties.encryption.keySource)"'
  not_expect     : "(Key Vault Properties: null|Encryption Type: Microsoft\.Storage)"
  severity       : MEDIUM
</custom_item>

<report type:"WARNING">
  description : "6.1.5 Ensure that Network Security Group Flow logs are captured and sent to Log Analytics"
  info        : "Ensure that network flow logs are captured and fed into a central log analytics workspace.

Rationale:

Network Flow Logs provide valuable insight into the flow of traffic around your network and feed into both Azure Monitor and Azure Sentinel (if in use), permitting the generation of visual flow diagrams to aid with analyzing for lateral movement, etc.

Impact:

The impact of configuring NSG Flow logs is primarily one of cost and configuration. If deployed, it will create storage accounts that hold minimal amounts of data on a 5-day lifecycle before feeding to Log Analytics Workspace. This will increase the amount of data stored and used by Azure Monitor.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Navigate to Network Watcher.

Under Logs, select Flow logs.

Select + Create.

Select the desired Subscription.

For Flow log type, select Network security group.

Select + Select target resource.

Select Network security group.

Select a network security group.

Click Confirm selection.

Select or create a new Storage Account.

If using a v2 storage account, input the retention in days to retain the log.

Click Next.

Under Analytics, for Flow log version, select Version 2.

Check the box next to Enable traffic analytics.

Select a processing interval.

Select a Log Analytics Workspace.

Select Next.

Optionally add Tags.

Select Review + create.

Select Create.

Warning
The remediation policy creates remediation deployment and names them by concatenating the subscription name and the resource group name. The MAXIMUM permitted length of a deployment name is 64 characters. Exceeding this will cause the remediation task to fail.

Default Value:

By default Network Security Group logs are not sent to Log Analytics."
  reference   : "800-171|3.14.6,800-171|3.14.7,800-53|SI-4,800-53|SI-4(4),800-53r5|SI-4,800-53r5|SI-4(4),CN-L3|7.1.2.2(c),CN-L3|7.1.3.5(a),CN-L3|8.1.10.5(b),CN-L3|8.1.10.6(f),CSCv7|12.8,CSCv8|13.6,CSF|DE.AE-1,CSF|DE.AE-2,CSF|DE.AE-3,CSF|DE.AE-4,CSF|DE.CM-1,CSF|DE.CM-5,CSF|DE.CM-6,CSF|DE.CM-7,CSF|DE.DP-2,CSF|DE.DP-3,CSF|DE.DP-4,CSF|DE.DP-5,CSF|ID.RA-1,CSF|PR.DS-5,CSF|PR.IP-8,CSF|RS.AN-1,CSF|RS.CO-3,CSF2.0|DE.AE-02,CSF2.0|DE.AE-03,CSF2.0|DE.CM-01,CSF2.0|DE.CM-06,CSF2.0|DE.CM-09,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|ID.RA-01,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|SI-4,ITSG-33|SI-4(4),LEVEL|2M,NESA|M1.2.2,NIAv2|NS32,QCSC-v1|3.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,SWIFT-CSCv1|6.5"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<report type:"WARNING">
  description : "6.1.6 Ensure that logging for Azure AppService 'HTTP logs' is enabled"
  info        : "Enable AppServiceHTTPLogs diagnostic log category for Azure App Service instances to ensure all http requests are captured and centrally logged.

Rationale:

Capturing web requests can be important supporting information for security analysts performing monitoring and incident response activities. Once logging, these logs can be ingested into SIEM or other central aggregation point for the organization.

Impact:

Log consumption and processing will incur additional cost.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Go to App Services.

For each App Service:

Under Monitoring, go to Diagnostic settings.

To update an existing diagnostic setting, click Edit setting against the setting. To create a new diagnostic setting, click Add diagnostic setting and provide a name for the new setting.

Check the checkbox next to HTTP logs.

Configure a destination based on your specific logging consumption capability (for example Stream to an event hub and then consuming with SIEM integration for Event Hub logging).

Click Save.

Default Value:

Not configured."
  reference   : "800-171|3.3.1,800-171|3.3.2,800-53|AU-2,800-53r5|AU-2,CN-L3|8.1.4.3(a),CSCv7|7.6,CSCv8|8.7,CSF|PR.PT-1,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-2,LEVEL|2M,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,QCSC-v1|8.2.1,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "6.3.1 Ensure Application Insights are Configured"
  info           : "Application Insights within Azure act as an Application Performance Monitoring solution providing valuable data into how well an application performs and additional information when performing incident response. The types of log data collected include application metrics, telemetry data, and application trace logging data providing organizations with detailed information about application activity and application transactions. Both data sets help organizations adopt a proactive and retroactive means to handle security and performance related metrics within their modern applications.

Rationale:

Configuring Application Insights provides additional data not found elsewhere within Azure as part of a much larger logging and monitoring program within an organization's Information Security practice. The types and contents of these logs will act as both a potential cost saving measure (application performance) and a means to potentially confirm the source of a potential incident (trace logging). Metrics and Telemetry data provide organizations with a proactive approach to cost savings by monitoring an application's performance, while the trace logging data provides necessary details in a reactive incident response scenario by helping organizations identify the potential source of an incident within their application.

Impact:

Because Application Insights relies on a Log Analytics Workspace, an organization will incur additional expenses when using this service."
  solution       : "Remediate from Azure Portal

Navigate to Application Insights.

Under the Basics tab within the PROJECT DETAILS section, select the Subscription.

Select the Resource group.

Within the INSTANCE DETAILS, enter a Name.

Select a Region.

Next to Resource Mode, select Workspace-based.

Within the WORKSPACE DETAILS, select the Subscription for the log analytics workspace.

Select the appropriate Log Analytics Workspace.

Click Next:Tags >.

Enter the appropriate Tags as Name, Value pairs.

Click Next:Review+Create.

Click Create.

Remediate from Azure CLI

az monitor app-insights component create --app <app name> --resource-group <resource group name> --location <location> --kind 'web' --retention-time <INT days to retain logs> --workspace <log analytics workspace ID> --subscription <subscription ID>

Remediate from PowerShell

New-AzApplicationInsights -Kind 'web' -ResourceGroupName <resource group name> -Name <app insights name> -location <location> -RetentionInDays <INT days to retain logs> -SubscriptionID <subscription ID> -WorkspaceResourceId <log analytics workspace ID>

Default Value:

Application Insights are not enabled by default."
  reference      : "800-171|3.3.1,800-171|3.3.2,800-171|3.3.6,800-53|AU-2,800-53|AU-7,800-53|AU-12,800-53r5|AU-2,800-53r5|AU-7,800-53r5|AU-12,CN-L3|7.1.2.3(c),CN-L3|8.1.4.3(a),CSCv7|6.2,CSCv8|8.2,CSF|DE.CM-1,CSF|DE.CM-3,CSF|DE.CM-7,CSF|PR.PT-1,CSF|RS.AN-3,CSF2.0|DE.CM-01,CSF2.0|DE.CM-03,CSF2.0|DE.CM-09,CSF2.0|PR.PS-04,CSF2.0|RS.AN-03,CSF2.0|RS.AN-06,CSF2.0|RS.AN-07,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-2,ITSG-33|AU-7,ITSG-33|AU-12,LEVEL|2A,NESA|M1.2.2,NESA|M5.5.1,NIAv2|AM7,NIAv2|AM11a,NIAv2|AM11b,NIAv2|AM11c,NIAv2|AM11d,NIAv2|AM11e,NIAv2|SS30,NIAv2|VL8,PCI-DSSv3.2.1|10.1,QCSC-v1|3.2,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,QCSC-v1|11.2,QCSC-v1|13.2,SWIFT-CSCv1|6.4"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listInsightsComponents"
  json_transform : '.[]|.subscriptionId as $subid| if (.value[] | length) == 0 then "Subscription ID: \($subid) - Insights not configured" else (.value[] | "Subscription ID: \($subid), ID: \(.properties.AppId), Name: \(.name), Location: \(.location)") end'
  not_expect     : "Insights not configured"
</custom_item>

<report type:"WARNING">
  description : "6.5 Ensure that SKU Basic/Consumption is not used on artifacts that need to be monitored (Particularly for Production Workloads)"
  info        : "The use of Basic or Free SKUs in Azure whilst cost effective have significant limitations in terms of what can be monitored and what support can be realized from Microsoft. Typically, these SKU's do not have a service SLA and Microsoft may refuse to provide support for them. Consequently Basic/Free SKUs should never be used for production workloads.

Rationale:

Typically, production workloads need to be monitored and should have an SLA with Microsoft, using Basic SKUs for any deployed product will mean that that these capabilities do not exist.

The following resource types should use standard SKUs as a minimum.

Public IP Addresses

Network Load Balancers

REDIS Cache

SQL PaaS Databases

VPN Gateways

Impact:

The impact of enforcing Standard SKU's is twofold

There will be a cost increase

The monitoring and service level agreements will be available and will support the production service.

All resources should be either tagged or in separate Management Groups/Subscriptions

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Each artifact has its own process for upgrading from basic to standard SKU's and this should be followed if required.

Default Value:

Policy should enforce standard SKUs for the following artifacts:

Public IP Addresses

Network Load Balancers

REDIS Cache

SQL PaaS Databases

VPN Gateways"
  reference   : "800-53|SA-22,800-53r5|SA-22,CSCv7|2.2,CSCv8|2.2,CSF2.0|ID.AM-08,GDPR|32.1.b,HIPAA|164.306(a)(1),LEVEL|2M"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "7.5 Ensure that Network Security Group Flow Log retention period is 'greater than 90 days'"
  info           : "Network Security Group Flow Logs should be enabled and the retention period set to greater than or equal to 90 days.

Rationale:

Flow logs enable capturing information about IP traffic flowing in and out of network security groups. Logs can be used to check for anomalies and give insight into suspected breaches.

Impact:

This will keep IP traffic logs for longer than 90 days. As a level 2, first determine your need to retain data, then apply your selection here. As this is data stored for longer, your monthly storage costs will increase depending on your data use."
  solution       : "Remediate from Azure Portal

Go to Network Watcher

Select NSG flow logs blade in the Logs section

Select each Network Security Group from the list

Ensure Status is set to On

Ensure Retention (days) setting greater than 90 days

Select your storage account in the Storage account field

Select Save

Remediate from Azure CLI
Enable the NSG flow logs and set the Retention (days) to greater than or equal to 90 days.

az network watcher flow-log configure --nsg <NameorID of the Network Security Group> --enabled true --resource-group <resourceGroupName> --retention 91 --storage-account <NameorID of the storage account to save flow logs>

Default Value:

By default, Network Security Group Flow Logs are disabled."
  reference      : "800-53|AU-4,800-53|AU-11,800-53r5|AU-4,800-53r5|AU-11,CSCv7|6.4,CSCv8|8.3,CSCv8|8.10,CSF|PR.DS-4,CSF|PR.PT-1,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-4,ITSG-33|AU-11,LEVEL|2A,NESA|M5.2.3,NESA|T3.3.1,NESA|T3.6.2,NIAv2|SM7,PCI-DSSv3.2.1|10.7,PCI-DSSv4.0|10.5.1,QCSC-v1|8.2.1,QCSC-v1|13.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listNetworkWatcherFlowLogs"
  json_transform : '.[]|.subscriptionId as $id| .resourceGroups[]|.name as $name|.NetworkWatchers[]|.name as $nwname|.value[]|"Subscription ID: \($id), Resource Group: \($name), Network Watcher: \($nwname), Flow Logs Name: \(.name), Enabled: \(.properties.enabled), Retention Policy: \(.properties.retentionPolicy.days)"'
  expect         : 'Enabled: true, Retention Policy: (9[1-9]|[1-9][0-9][0-9]+)'
  match_all      : YES
</custom_item>

<report type:"WARNING">
  description : "7.6 Ensure that Network Watcher is 'Enabled' for Azure Regions that are in use"
  info        : "Enable Network Watcher for physical regions in Azure subscriptions.

Rationale:

Network diagnostic and visualization tools available with Network Watcher help users understand, diagnose, and gain insights to the network in Azure.

Impact:

There are additional costs per transaction to run and store network data. For high-volume networks these charges will add up quickly.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Opting out of Network Watcher automatic enablement is a permanent change. Once you opt-out you cannot opt-in without contacting support.
To manually enable Network Watcher in each region where you want to use Network Watcher capabilities, follow the steps below.
Remediate from Azure Portal

Use the Search bar to search for and click on the Network Watcher service.

Click Create.

Select a Region from the drop-down menu.

Click Add.

Remediate from Azure CLI

az network watcher configure --locations <region> --enabled true --resource-group <resource_group>

Default Value:

Network Watcher is automatically enabled. When you create or update a virtual network in your subscription, Network Watcher will be enabled automatically in your Virtual Network's region. There is no impact to your resources or associated charge for automatically enabling Network Watcher."
  reference   : "800-171|3.4.6,800-171|3.4.7,800-171|3.13.1,800-171|3.13.2,800-171|3.13.5,800-53|CM-7,800-53|CP-6,800-53|CP-7,800-53|PL-8,800-53|PM-5,800-53|PM-7,800-53|SA-8,800-53|SC-7,800-53r5|CM-7,800-53r5|CP-6,800-53r5|CP-7,800-53r5|PL-8,800-53r5|PM-5,800-53r5|PM-7,800-53r5|SA-8,800-53r5|SC-7,CN-L3|8.1.10.6(j),CSCv7|11.2,CSCv7|12.1,CSCv8|12.2,CSCv8|12.4,CSF|DE.CM-1,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-5,CSF|PR.IP-1,CSF|PR.IP-2,CSF|PR.IP-4,CSF|PR.PT-3,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|ID.AM-03,CSF2.0|ID.AM-08,CSF2.0|ID.IM-01,CSF2.0|ID.IM-02,CSF2.0|ID.IM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.DS-11,CSF2.0|PR.IR-01,CSF2.0|PR.IR-03,CSF2.0|PR.IR-04,CSF2.0|PR.PS-01,CSF2.0|PR.PS-06,GDPR|32.1.b,GDPR|32.1.c,GDPR|32.1.d,HIPAA|164.306(a)(1),ISO/IEC-27001|A.13.1.3,ITSG-33|CM-7,ITSG-33|CP-6,ITSG-33|CP-7,ITSG-33|SA-8,ITSG-33|SA-8a.,ITSG-33|SC-7,LEVEL|2A,NESA|T1.2.1,NESA|T1.2.2,NESA|T2.2.4,NESA|T3.4.1,NESA|T4.5.3,NESA|T4.5.4,NESA|T7.6.5,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,NIAv2|SS3,NIAv2|SS15a,NIAv2|VL2,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv3.2.1|2.2.2,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,QCSC-v1|10.2.1,SWIFT-CSCv1|2.3,TBA-FIISB|43.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<custom_item>
  description    : "8.1 Ensure an Azure Bastion Host Exists"
  info           : "The Azure Bastion service allows secure remote access to Azure Virtual Machines over the Internet without exposing remote access protocol ports and services directly to the Internet. The Azure Bastion service provides this access using TLS over 443/TCP, and subscribes to hardened configurations within an organization's Azure Active Directory service.

Rationale:

The Azure Bastion service allows organizations a more secure means of accessing Azure Virtual Machines over the Internet without assigning public IP addresses to those Virtual Machines. The Azure Bastion service provides Remote Desktop Protocol (RDP) and Secure Shell (SSH) access to Virtual Machines using TLS within a web browser, thus preventing organizations from opening up 3389/TCP and 22/TCP to the Internet on Azure Virtual Machines. Additional benefits of the Bastion service includes Multi-Factor Authentication, Conditional Access Policies, and any other hardening measures configured within Azure Active Directory using a central point of access.

Impact:

The Azure Bastion service incurs additional costs and requires a specific virtual network configuration. The Standard tier offers additional configuration options compared to the Basic tier and may incur additional costs for those added features."
  solution       : "Remediate from Azure Portal

Click on Bastions

Select the Subscription

Select the Resource group

Type a Name for the new Bastion host

Select a Region

Choose Standard next to Tier

Use the slider to set the Instance count

Select the Virtual network or Create new

Select the Subnet named AzureBastionSubnet. Create a Subnet named AzureBastionSubnet using a /26 CIDR range if it doesn't already exist.

Selct the appropriate Public IP address option.

If Create new is selected for the Public IP address option, provide a Public IP address name.

If Use existing is selected for Public IP address option, select an IP address from Choose public IP address

Click Next: Tags >

Configure the appropriate Tags

Click Next: Advanced >

Select the appropriate Advanced options

Click Next: Review + create >

Click Create

Remediate from Azure CLI

az network bastion create --location <location> --name <name of bastion host> --public-ip-address <public IP address name or ID> --resource-group <resource group name or ID> --vnet-name <virtual network containing subnet called 'AzureBastionSubnet'> --scale-units <integer> --sku Standard [--disable-copy-paste true|false] [--enable-ip-connect true|false] [--enable-tunneling true|false]

Remediate from PowerShell
Create the appropriate Virtual network settings and Public IP Address settings.

$subnetName = 'AzureBastionSubnet'
$subnet = New-AzVirtualNetworkSubnetConfig -Name $subnetName -AddressPrefix <IP address range in CIDR notation making sure to use a /26>
$virtualNet = New-AzVirtualNetwork -Name <virtual network name> -ResourceGroupName <resource group name> -Location <location> -AddressPrefix <IP address range in CIDR notation> -Subnet $subnet
$publicip = New-AzPublicIpAddress -ResourceGroupName <resource group name> -Name <public IP address name> -Location <location> -AllocationMethod Dynamic -Sku Standard

Create the Azure Bastion service using the information within the created variables from above.

New-AzBastion -ResourceGroupName <resource group name> -Name <bastion name> -PublicIpAddress $publicip -VirtualNetwork $virtualNet -Sku 'Standard' -ScaleUnit <integer>

Default Value:

By default, the Azure Bastion service is not configured."
  reference      : "800-171|3.4.1,800-171|3.13.1,800-171|3.13.5,800-53|CA-9,800-53|CM-8,800-53|CM-8(1),800-53|SC-7,800-53r5|CA-9,800-53r5|CM-8,800-53r5|CM-8(1),800-53r5|SC-7,CN-L3|8.1.10.2(a),CN-L3|8.1.10.2(b),CN-L3|8.1.10.6(j),CSCv7|9.2,CSCv7|11.2,CSCv7|12.1,CSCv8|12.1,CSCv8|13.4,CSF|DE.CM-1,CSF|DE.CM-7,CSF|ID.AM-1,CSF|ID.AM-2,CSF|ID.AM-3,CSF|PR.AC-5,CSF|PR.DS-3,CSF|PR.DS-5,CSF|PR.PT-4,CSF2.0|DE.CM-01,CSF2.0|ID.AM-01,CSF2.0|ID.AM-02,CSF2.0|ID.AM-03,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,CSF2.0|PR.PS-01,GDPR|32.1.b,GDPR|32.1.d,GDPR|32.2,HIPAA|164.306(a)(1),ISO/IEC-27001|A.13.1.3,ITSG-33|CM-8,ITSG-33|CM-8(1),ITSG-33|SC-7,LEVEL|2A,NESA|T1.2.1,NESA|T1.2.2,NESA|T4.5.4,NIAv2|GS1,NIAv2|GS2a,NIAv2|GS2b,PCI-DSSv3.2.1|1.1,PCI-DSSv3.2.1|1.2,PCI-DSSv3.2.1|1.2.1,PCI-DSSv3.2.1|1.3,PCI-DSSv4.0|1.2.1,PCI-DSSv4.0|1.4.1,QCSC-v1|3.2,QCSC-v1|4.2,QCSC-v1|5.2.1,QCSC-v1|5.2.2,QCSC-v1|5.2.3,QCSC-v1|6.2,QCSC-v1|8.2.1,SWIFT-CSCv1|2.1,TBA-FIISB|43.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listNetworkBastionHosts"
  json_transform : '.[]|.subscriptionId as $id| "Subscription ID: \($id), Bastian Hosts: \([ .value[] | .name ])"'
  expect         : "Bastian Hosts: \[.+\]"
</custom_item>

<custom_item>
  description    : "8.3 Ensure that 'OS and Data' disks are encrypted with Customer Managed Key (CMK)"
  info           : "Ensure that OS disks (boot volumes) and data disks (non-boot volumes) are encrypted with CMK (Customer Managed Keys). Customer Managed keys can be either ADE or Server Side Encryption (SSE).

Rationale:

Encrypting the IaaS VM's OS disk (boot volume) and Data disks (non-boot volume) ensures that the entire content is fully unrecoverable without a key, thus protecting the volume from unwanted reads. PMK (Platform Managed Keys) are enabled by default in Azure-managed disks and allow encryption at rest. CMK is recommended because it gives the customer the option to control which specific keys are used for the encryption and decryption of the disk. The customer can then change keys and increase security by disabling them instead of relying on the PMK key that remains unchanging. There is also the option to increase security further by using automatically rotating keys so that access to disk is ensured to be limited. Organizations should evaluate what their security requirements are, however, for the data stored on the disk. For high-risk data using CMK is a must, as it provides extra steps of security. If the data is low risk, PMK is enabled by default and provides sufficient data security.

Impact:

Using CMK/BYOK will entail additional management of keys.

NOTE: You must have your key vault set up to utilize this."
  solution       : "Remediate from Azure Portal
Note: Disks must be detached from VMs to have encryption changed.

Go to Virtual machines

For each virtual machine, go to Settings

Click on Disks

Click the ellipsis (...), then click Detach to detach the disk from the VM

Now search for Disks and locate the unattached disk

Click the disk then select Encryption

Change your encryption type, then select your encryption set

Click Save

Go back to the VM and re-attach the disk

Remediate from PowerShell

$KVRGname = 'MyKeyVaultResourceGroup';
 $VMRGName = 'MyVirtualMachineResourceGroup';
 $vmName = 'MySecureVM';
 $KeyVaultName = 'MySecureVault';
 $KeyVault = Get-AzKeyVault -VaultName $KeyVaultName -ResourceGroupName $KVRGname;
 $diskEncryptionKeyVaultUrl = $KeyVault.VaultUri;
 $KeyVaultResourceId = $KeyVault.ResourceId;

 Set-AzVMDiskEncryptionExtension -ResourceGroupName $VMRGname -VMName $vmName -DiskEncryptionKeyVaultUrl $diskEncryptionKeyVaultUrl -DiskEncryptionKeyVaultId $KeyVaultResourceId;

NOTE:
During encryption it is likely that a reboot will be required. It may take up to 15 minutes to complete the process.
For Linux machines you may need to set the -skipVmBackup parameter.

Default Value:

By default, Azure disks are encrypted using SSE with PMK."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listDisksBySubscription"
  json_transform : '.[]|.subscriptionId as $subid|.value[]|.name as $diskname|"Subscription ID: \($subid), Disk Name: \($diskname), Encryption: \(.properties.encryption.type)"'
  not_expect     : 'Encryption: EncryptionAtRestWithPlatformKey'
</custom_item>

<custom_item>
  description    : "8.4 Ensure that 'Unattached disks' are encrypted with 'Customer Managed Key' (CMK)"
  info           : "Ensure that unattached disks in a subscription are encrypted with a Customer Managed Key (CMK).

Rationale:

Managed disks are encrypted by default with Platform-managed keys. Using Customer-managed keys may provide an additional level of security or meet an organization's regulatory requirements. Encrypting managed disks ensures that its entire content is fully unrecoverable without a key and thus protects the volume from unwarranted reads. Even if the disk is not attached to any of the VMs, there is always a risk where a compromised user account with administrative access to VM service can mount/attach these data disks, which may lead to sensitive information disclosure and tampering.

Impact:

NOTE: You must have your key vault set up to utilize this. Encryption is available only on Standard tier VMs. This might cost you more.

Utilizing and maintaining Customer-managed keys will require additional work to create, protect, and rotate keys."
  solution       : "If data stored in the disk is no longer useful, refer to Azure documentation to delete unattached data disks at:

-https://docs.microsoft.com/en-us/rest/api/compute/disks/delete
-https://docs.microsoft.com/en-us/cli/azure/disk?view=azure-cli-latest#az-disk-delete

If data stored in the disk is important, to encrypt the disk refer to azure documentation at:

-https://docs.microsoft.com/en-us/azure/virtual-machines/disks-enable-customer-managed-keys-portal
-https://docs.microsoft.com/en-us/rest/api/compute/disks/update#encryptionsettings

Default Value:

By default, managed disks are encrypted with a Platform-managed key."
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2A,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listDisksBySubscription"
  json_transform : '.[]|.subscriptionId as $subid|.value[]|select(.properties.diskState == "Unattached")|.name as $diskname|"Subscription ID: \($subid), Disk Name: \($diskname), Disk State: \(.properties.diskState), Encryption: \(.properties.encryption.type)"'
  not_expect     : 'Disk State: Unattached, Encryption: EncryptionAtRestWithPlatformKey'
</custom_item>

<custom_item>
  description    : "8.8 Ensure that Endpoint Protection for all Virtual Machines is installed"
  info           : "Install endpoint protection for all virtual machines.

Rationale:

Installing endpoint protection systems (like anti-malware for Azure) provides for real-time protection capability that helps identify and remove viruses, spyware, and other malicious software. These also offer configurable alerts when known-malicious or unwanted software attempts to install itself or run on Azure systems.

Impact:

Endpoint protection will incur an additional cost to you.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Follow Microsoft Azure documentation to install endpoint protection from the security center. Alternatively, you can employ your own endpoint protection tool for your OS.

Default Value:

By default Endpoint Protection is disabled."
  reference      : "800-171|3.14.2,800-171|3.14.4,800-171|3.14.5,800-53|SI-3,800-53r5|SI-3,CN-L3|7.1.3.6(b),CN-L3|8.1.4.5,CN-L3|8.1.9.6(a),CN-L3|8.1.9.6(b),CN-L3|8.1.10.5(b),CN-L3|8.1.10.7(a),CN-L3|8.1.10.7(b),CSCv7|8.2,CSCv8|10.2,CSF|DE.CM-4,CSF|DE.DP-3,CSF2.0|PR.DS-01,CSF2.0|PR.DS-02,CSF2.0|PR.DS-10,GDPR|32.1.b,HIPAA|164.306(a)(1),ISO/IEC-27001|A.12.2.1,ITSG-33|SI-3,LEVEL|2M,NIAv2|GS8a,PCI-DSSv3.2.1|5.1,PCI-DSSv3.2.1|5.1.1,PCI-DSSv4.0|5.2.1,QCSC-v1|3.2,QCSC-v1|5.2.3,QCSC-v1|8.2.1,TBA-FIISB|49.2.1,TBA-FIISB|49.2.2,TBA-FIISB|49.3.1,TBA-FIISB|49.3.2,TBA-FIISB|50.2.1,TBA-FIISB|51.2.4,TBA-FIISB|51.2.7"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listVMInstanceView"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.VMs[]|.name as $vmname|"Subscription ID: \($subid), Resource Group: \($rgname), VM Name: \($vmname), Extension Name: \(.value.extensions[].name)"'
  expect         : "(EndpointSecurity|TrendMicroDSA|Antimalware|EndpointProtection|SCWPAgent|PortalProtectExtension|FileSecurity)"
  match_all      : YES
  severity       : MEDIUM
</custom_item>

<custom_item>
  description    : "8.9 [Legacy] Ensure that VHDs are Encrypted"
  info           : "NOTE: This is a legacy recommendation. Managed Disks are encrypted by default and recommended for all new VM implementations.

VHD (Virtual Hard Disks) are stored in blob storage and are the old-style disks that were attached to Virtual Machines. The blob VHD was then leased to the VM. By default, storage accounts are not encrypted, and Microsoft Defender will then recommend that the OS disks should be encrypted. Storage accounts can be encrypted as a whole using PMK or CMK. This should be turned on for storage accounts containing VHDs.

Rationale:

While it is recommended to use Managed Disks which are encrypted by default, 'legacy' VHDs may exist for a variety of reasons and may need to remain in VHD format. VHDs are not encrypted by default, so this recommendation intends to address the security of these disks. In these niche cases, VHDs should be encrypted using the procedures in this recommendation to encrypt and protect the data content.

If a virtual machine is using a VHD and can be converted to a managed disk, instructions for this procedure can be found in the resources section of this recommendation under the title 'Convert VHD to Managed Disk.'

Impact:

Depending on how the encryption is implemented will change the size of the impact. If provider-managed keys(PMK) are utilized, the impact is relatively low, but processes need to be put in place to regularly rotate the keys. If Customer-managed keys(CMK) are utilized, a key management process needs to be implemented to store and manage key rotation, thus the impact is medium to high depending on user maturity with key management."
  solution       : "Remediate from Azure Portal

Navigate to the storage account that you wish to encrypt

Select encryption

Select the encryption type that you wish to use

If you wish to use a Microsoft-managed key (the default), you can save at this point and encryption will be applied to the account.
If you select Customer-managed keys, it will ask for the location of the key (The default is an Azure Key Vault) and the key name.
Once these are captured, save the configuration and the account will be encrypted using the provided key.

Remediate from Azure CLI:
Create the Key Vault

az keyvault create --name <name> --resource-group <resourceGroup> --location <location> --enabled-for-disk-encryption

Encrypt the disk and store the key in Key Vault

az vm encryption enable -g <resourceGroup> --name <name> --disk-encryption-keyvault myKV

Remediate from PowerShell
This process uses a Key Vault to store the keys
Create the Key Vault

New-AzKeyvault -name <name> -ResourceGroupName <resourceGroup> -Location <location> -EnabledForDiskEncryption

Encrypt the disk and store the key in Key Vault

$KeyVault = Get-AzKeyVault -VaultName <name> -ResourceGroupName <resourceGroup>

Set-AzVMDiskEncryptionExtension -ResourceGroupName <resourceGroup> -VMName <name> -DiskEncryptionKeyVaultUrl $KeyVault.VaultUri -DiskEncryptionKeyVaultId $KeyVault.ResourceId

Default Value:

The default value for encryption is 'NO Encryption'"
  reference      : "800-171|3.5.2,800-171|3.13.16,800-53|IA-5(1),800-53|SC-28,800-53|SC-28(1),800-53r5|IA-5(1),800-53r5|SC-28,800-53r5|SC-28(1),CN-L3|8.1.4.7(b),CN-L3|8.1.4.8(b),CSCv7|14.8,CSCv8|3.11,CSF|PR.AC-1,CSF|PR.DS-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,CSF2.0|PR.DS-01,GDPR|32.1.a,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(a)(2)(iv),HIPAA|164.312(d),HIPAA|164.312(e)(2)(ii),ITSG-33|IA-5(1),ITSG-33|SC-28,ITSG-33|SC-28a.,ITSG-33|SC-28(1),LEVEL|2M,NESA|T5.2.3,PCI-DSSv3.2.1|3.4,PCI-DSSv4.0|3.3.2,PCI-DSSv4.0|3.5.1,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|4.1,TBA-FIISB|28.1"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listStorageAccounts"
  json_transform : '.[]|.subscriptionId as $id| .value[]| .name as $name| "Subscription ID: \($id), Name: \($name), Enabled: \(.properties.encryption.services.blob.enabled)"'
  not_expect     : "Enabled: false"
</custom_item>

<report type:"WARNING">
  description : "8.10 Ensure only MFA enabled identities can access privileged Virtual Machine"
  info        : "Verify identities without MFA that can log in to a privileged virtual machine using separate login credentials. An adversary can leverage the access to move laterally and perform actions with the virtual machine's managed identity. Make sure the virtual machine only has necessary permissions, and revoke the admin-level permissions according to the least privileges principal

Rationale:

Integrating multi-factor authentication (MFA) as part of the organizational policy can greatly reduce the risk of an identity gaining control of valid credentials that may be used for additional tactics such as initial access, lateral movement, and collecting information. MFA can also be used to restrict access to cloud resources and APIs.

An Adversary may log into accessible cloud services within a compromised environment using Valid Accounts that are synchronized to move laterally and perform actions with the virtual machine's managed identity. The adversary may then perform management actions or access cloud-hosted resources as the logged-on managed identity.

Impact:

This recommendation requires the Entra ID P2 license to implement.

Ensure that identities that are provisioned to a virtual machine utilizes an RBAC/ABAC group and is allocated a role using Azure PIM, and the Role settings require MFA or use another third-party PAM solution for accessing Virtual Machines.

NOTE: Nessus has not performed this check. Please review the benchmark to ensure target compliance."
  solution    : "Remediate from Azure Portal

Log in to the Azure portal.

This can be remediated by enabling MFA for user, Removing user access or Reducing access of managed identities attached to virtual machines.

Case I : Enable MFA for users having access on virtual machines.

Navigate to Entra ID from the left pane and select Users from the Manage section.

Click on Per-User MFA from the top menu options and select each user with MULTI-FACTOR AUTH STATUS as Disabled and can login to virtual machines:

From quick steps on the right side select enable.

Click on enable multi-factor auth and share the link with the user to setup MFA as required.

Case II : Removing user access on a virtual machine.

Select the Subscription, then click on Access control (IAM).

Select Role assignments and search for Virtual Machine Administrator Login or Virtual Machine User Login or any role that provides access to log into virtual machines.

Click on Role Name, Select Assignments, and remove identities with no MFA configured.

Case III : Reducing access of managed identities attached to virtual machines.

Select the Subscription, then click on Access control (IAM).

Select Role Assignments from the top menu and apply filters on Assignment type as Privileged administrator roles and Type as Virtual Machines.

Click on Role Name, Select Assignments, and remove identities access make sure this follows the least privileges principal."
  reference   : "800-171|3.5.3,800-53|IA-2(1),800-53r5|IA-2(1),CN-L3|7.1.2.7(b),CSCv7|4.5,CSCv8|6.5,CSF|PR.AC-1,CSF2.0|PR.AA-01,CSF2.0|PR.AA-03,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(2)(i),HIPAA|164.312(d),ITSG-33|IA-2(1),LEVEL|2M,NESA|T5.4.2,NIAv2|AM36,NIAv2|VL3c,QCSC-v1|5.2.2,QCSC-v1|13.2,SWIFT-CSCv1|1.2,TBA-FIISB|35.1,TBA-FIISB|36.1"
  see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
</report>

<if>
  <condition type:"AND">
    <custom_item>
      description    : "Auth Settings"
      request        : "listAppConfig"
      json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.WebApps[]|.name as $appname|"Subscription ID: \($subid), Resource Group: \($rgname), App Name: \($appname), App Service Auth: \(.value[].properties.siteAuthEnabled)"'
      not_expect     : "App Service Auth: false"
    </custom_item>

    <custom_item>
      description    : "Basic Publishing Credentials Policy - FTP"
      request        : "listWebAppsBasicPublishingCredentialsPolicyFTP"
      json_transform : '.[] | .subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.WebApps[]|.name as $appname |"Subscription ID: \($subid), Resource Group: \($rgname), App Name: \($appname), Allow: \(.value.properties.allow)"'
      not_expect     : "Allow: true"
    </custom_item>

    <custom_item>
      description    : "Basic Publishing Credentials Policy - SCM"
      request        : "listWebAppsBasicPublishingCredentialsPolicySCM"
      json_transform : '.[] | .subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.WebApps[]|.name as $appname |"Subscription ID: \($subid), Resource Group: \($rgname), App Name: \($appname), Allow: \(.value.properties.allow)"'
      not_expect     : "Allow: true"
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "9.2 Ensure App Service Authentication is set up for apps in Azure App Service"
      info        : "Azure App Service Authentication is a feature that can prevent anonymous HTTP requests from reaching a Web Application or authenticate those with tokens before they reach the app. If an anonymous request is received from a browser, App Service will redirect to a logon page. To handle the logon process, a choice from a set of identity providers can be made, or a custom authentication mechanism can be implemented.

Rationale:

By Enabling App Service Authentication, every incoming HTTP request passes through it before being handled by the application code. It also handles authentication of users with the specified provider (Entra ID, Facebook, Google, Microsoft Account, and Twitter), validation, storing and refreshing of tokens, managing the authenticated sessions and injecting identity information into request headers. Disabling HTTP Basic Authentication functionality further ensures legacy authentication methods are disabled within the application.

Impact:

This is only required for App Services which require authentication. Enabling on site like a marketing or support website will prevent unauthenticated access which would be undesirable.

Adding Authentication requirement will increase cost of App Service and require additional security components to facilitate the authentication."
      solution    : "Remediate from Azure Portal

Login to Azure Portal using https://portal.azure.com

Go to App Services

Click on each App

Under Setting section, click on Authentication

If no identity providers are set up, then click Add identity provider

Choose other parameters as per your requirements and click on Add

To disable the Basic Auth Publishing Credentials setting, perform the following steps:

Login to Azure Portal using https://portal.azure.com

Go to App Services

Click on each App

Under Settings, click on Configuration

Click on the 'General Settings' tab

Under Platform settings, ensure Basic Auth Publishing Credentials is set to Off

Remediate from Azure CLI
To set App Service Authentication for an existing app, run the following command:

az webapp auth update --resource-group <RESOURCE_GROUP_NAME> --name <APP_NAME> --enabled true

Note
In order to access App Service authentication settings for Web app using Microsoft API requires Website contributor permission at subscription level. A custom role can be created in place of Website contributor to provide more specific permission and maintain the principle of least privileged access.

Default Value:

By default, App Service Authentication is disabled when a new app is created using the command-line tool or Azure Portal console."
      reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
      show_output : YES
    </report>
  </then>

  <else>
    <report type:"FAILED">
      description : "9.2 Ensure App Service Authentication is set up for apps in Azure App Service"
      info        : "Azure App Service Authentication is a feature that can prevent anonymous HTTP requests from reaching a Web Application or authenticate those with tokens before they reach the app. If an anonymous request is received from a browser, App Service will redirect to a logon page. To handle the logon process, a choice from a set of identity providers can be made, or a custom authentication mechanism can be implemented.

Rationale:

By Enabling App Service Authentication, every incoming HTTP request passes through it before being handled by the application code. It also handles authentication of users with the specified provider (Entra ID, Facebook, Google, Microsoft Account, and Twitter), validation, storing and refreshing of tokens, managing the authenticated sessions and injecting identity information into request headers. Disabling HTTP Basic Authentication functionality further ensures legacy authentication methods are disabled within the application.

Impact:

This is only required for App Services which require authentication. Enabling on site like a marketing or support website will prevent unauthenticated access which would be undesirable.

Adding Authentication requirement will increase cost of App Service and require additional security components to facilitate the authentication."
      solution    : "Remediate from Azure Portal

Login to Azure Portal using https://portal.azure.com

Go to App Services

Click on each App

Under Setting section, click on Authentication

If no identity providers are set up, then click Add identity provider

Choose other parameters as per your requirements and click on Add

To disable the Basic Auth Publishing Credentials setting, perform the following steps:

Login to Azure Portal using https://portal.azure.com

Go to App Services

Click on each App

Under Settings, click on Configuration

Click on the 'General Settings' tab

Under Platform settings, ensure Basic Auth Publishing Credentials is set to Off

Remediate from Azure CLI
To set App Service Authentication for an existing app, run the following command:

az webapp auth update --resource-group <RESOURCE_GROUP_NAME> --name <APP_NAME> --enabled true

Note
In order to access App Service authentication settings for Web app using Microsoft API requires Website contributor permission at subscription level. A custom role can be created in place of Website contributor to provide more specific permission and maintain the principle of least privileged access.

Default Value:

By default, App Service Authentication is disabled when a new app is created using the command-line tool or Azure Portal console."
      reference   : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2A,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
      see_also    : "https://workbench.cisecurity.org/benchmarks/16820"
      show_output : YES
    </report>
  </else>
</if>

<custom_item>
  description    : "9.11 Ensure Azure Key Vaults are Used to Store Secrets"
  info           : "Azure Key Vault will store multiple types of sensitive information such as encryption keys, certificate thumbprints, and Managed Identity Credentials. Access to these 'Secrets' can be controlled through granular permissions.

Rationale:

The credentials given to an application have permissions to create, delete, or modify data stored within the systems they access. If these credentials are stored within the application itself, anyone with access to the application or a copy of the code has access to them. Storing within Azure Key Vault as secrets increases security by controlling access. This also allows for updates of the credentials without redeploying the entire application.

Impact:

Integrating references to secrets within the key vault are required to be specifically integrated within the application code. This will require additional configuration to be made during the writing of an application, or refactoring of an already written one. There are also additional costs that are charged per 10000 requests to the Key Vault."
  solution       : "Remediation has 2 steps

Setup the Key Vault

Setup the App Service to use the Key Vault

Step 1: Set up the Key Vault
Remediate from Azure CLI

az keyvault create --name '<name>' --resource-group '<myResourceGroup>' --location myLocation

Remediate from PowerShell

New-AzKeyvault -name <name> -ResourceGroupName <myResourceGroup> -Location <myLocation>

Step 2: Set up the App Service to use the Key Vault
Sample JSON Template for App Service Configuration (starting next page):

{
    //...
    'resources': [
        {
            'type': 'Microsoft.Storage/storageAccounts',
            'name': '[variables('storageAccountName')]',
            //...
        },
        {
            'type': 'Microsoft.Insights/components',
            'name': '[variables('appInsightsName')]',
            //...
        },
        {
            'type': 'Microsoft.Web/sites',
            'name': '[variables('functionAppName')]',
            'identity': {
                'type': 'SystemAssigned'
            },
            //...
            'resources': [
                {
                    'type': 'config',
                    'name': 'appsettings',
                    //...
                    'dependsOn': [
                        '[resourceId('Microsoft.Web/sites', variables('functionAppName'))]',
                        '[resourceId('Microsoft.KeyVault/vaults/', variables('keyVaultName'))]',
                        '[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), variables('storageConnectionStringName'))]',
                        '[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), variables('appInsightsKeyName'))]'
                    ],
                    'properties': {
                        'AzureWebJobsStorage': '[concat('@Microsoft.KeyVault(SecretUri=', reference(variables('storageConnectionStringResourceId')).secretUriWithVersion, ')')]',
                        'WEBSITE_CONTENTAZUREFILECONNECTIONSTRING': '[concat('@Microsoft.KeyVault(SecretUri=', reference(variables('storageConnectionStringResourceId')).secretUriWithVersion, ')')]',
                        'APPINSIGHTS_INSTRUMENTATIONKEY': '[concat('@Microsoft.KeyVault(SecretUri=', reference(variables('appInsightsKeyResourceId')).secretUriWithVersion, ')')]',
                        'WEBSITE_ENABLE_SYNC_UPDATE_SITE': 'true'
                        //...
                    }
                },
                {
                    'type': 'sourcecontrols',
                    'name': 'web',
                    //...
                    'dependsOn': [
                        '[resourceId('Microsoft.Web/sites', variables('functionAppName'))]',
                        '[resourceId('Microsoft.Web/sites/config', variables('functionAppName'), 'appsettings')]'
                    ],
                }
            ]
        },
        {
            'type': 'Microsoft.KeyVault/vaults',
            'name': '[variables('keyVaultName')]',
            //...
            'dependsOn': [
                '[resourceId('Microsoft.Web/sites', variables('functionAppName'))]'
            ],
            'properties': {
                //...
                'accessPolicies': [
                    {
                        'tenantId': '[reference(concat('Microsoft.Web/sites/',  variables('functionAppName'), '/providers/Microsoft.ManagedIdentity/Identities/default'), '2015-08-31-PREVIEW').tenantId]',
                        'objectId': '[reference(concat('Microsoft.Web/sites/',  variables('functionAppName'), '/providers/Microsoft.ManagedIdentity/Identities/default'), '2015-08-31-PREVIEW').principalId]',
                        'permissions': {
                            'secrets': [ 'get' ]
                        }
                    }
                ]
            },
            'resources': [
                {
                    'type': 'secrets',
                    'name': '[variables('storageConnectionStringName')]',
                    //...
                    'dependsOn': [
                        '[resourceId('Microsoft.KeyVault/vaults/', variables('keyVaultName'))]',
                        '[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]'
                    ],
                    'properties': {
                        'value': '[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountResourceId'),'2015-05-01-preview').key1)]'
                    }
                },
                {
                    'type': 'secrets',
                    'name': '[variables('appInsightsKeyName')]',
                    //...
                    'dependsOn': [
                        '[resourceId('Microsoft.KeyVault/vaults/', variables('keyVaultName'))]',
                        '[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]'
                    ],
                    'properties': {
                        'value': '[reference(resourceId('microsoft.insights/components/', variables('appInsightsName')), '2015-05-01').InstrumentationKey]'
                    }
                }
            ]
        }
    ]
}

Default Value:

By default, no Azure Key Vaults are created."
  reference      : "800-53|AU-11,800-53|SI-12,800-53r5|AU-11,800-53r5|CM-12,800-53r5|SI-12,CSCv7|13.1,CSCv8|3.1,CSF|PR.PT-1,CSF2.0|ID.AM-07,CSF2.0|ID.AM-08,CSF2.0|PR.PS-04,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(b),ITSG-33|AU-11,ITSG-33|SI-12,ITSG-33|SI-12a.,LEVEL|2M,NESA|M5.2.3,NESA|M5.2.4,NESA|M5.3.1,NESA|T3.6.2,NIAv2|DR1,NIAv2|DR1a,NIAv2|DR1b,NIAv2|DR1c,NIAv2|DR2,NIAv2|DR3,NIAv2|DR4,NIAv2|DR5,NIAv2|DR6,NIAv2|SM7,PCI-DSSv3.2.1|3.1,PCI-DSSv3.2.1|10.7,PCI-DSSv4.0|3.2.1,PCI-DSSv4.0|10.5.1,QCSC-v1|8.2.1,QCSC-v1|13.2"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listVaults"
  json_transform : '.[] | "Subscription ID: \(.id), Key Vaults Exist: \((.value | length) > 0)"'
  expect         : "Key Vaults Exist: true"
  match_all      : YES
</custom_item>

<custom_item>
  description    : "10.1 Ensure that Resource Locks are set for Mission-Critical Azure Resources"
  info           : "Resource Manager Locks provide a way for administrators to lock down Azure resources to prevent deletion of, or modifications to, a resource. These locks sit outside of the Role Based Access Controls (RBAC) hierarchy and, when applied, will place restrictions on the resource for all users. These locks are very useful when there is an important resource in a subscription that users should not be able to delete or change. Locks can help prevent accidental and malicious changes or deletion.

Rationale:

As an administrator, it may be necessary to lock a subscription, resource group, or resource to prevent other users in the organization from accidentally deleting or modifying critical resources. The lock level can be set to to CanNotDelete or ReadOnly to achieve this purpose.

CanNotDelete means authorized users can still read and modify a resource, but they cannot delete the resource.

ReadOnly means authorized users can read a resource, but they cannot delete or update the resource. Applying this lock is similar to restricting all authorized users to the permissions granted by the Reader role.

Impact:

There can be unintended outcomes of locking a resource. Applying a lock to a parent service will cause it to be inherited by all resources within. Conversely, applying a lock to a resource may not apply to connected storage, leaving it unlocked. Please see the documentation for further information.

NOTE: Nessus has provided the target output to assist in reviewing the benchmark to ensure target compliance."
  solution       : "Remediate from Azure Portal

Navigate to the specific Azure Resource or Resource Group.

For each mission critical resource, click on Locks.

Click Add.

Give the lock a name and a description, then select the type, Read-only or Delete as appropriate.

Click OK.

Remediate from Azure CLI
To lock a resource, provide the name of the resource, its resource type, and its resource group name.

az lock create --name <LockName> --lock-type <CanNotDelete/Read-only> --resource-group <resourceGroupName> --resource-name <resourceName> --resource-type <resourceType>

Remediate from PowerShell

Get-AzResourceLock -ResourceName <Resource Name> -ResourceType <Resource Type> -ResourceGroupName <Resource Group Name> -Locktype <CanNotDelete/Read-only>

Default Value:

By default, no locks are set."
  reference      : "800-171|3.1.1,800-171|3.1.4,800-171|3.1.5,800-171|3.8.1,800-171|3.8.2,800-171|3.8.3,800-53|AC-3,800-53|AC-5,800-53|AC-6,800-53|MP-2,800-53r5|AC-3,800-53r5|AC-5,800-53r5|AC-6,800-53r5|MP-2,CN-L3|7.1.3.2(b),CN-L3|7.1.3.2(g),CN-L3|8.1.4.2(d),CN-L3|8.1.4.2(f),CN-L3|8.1.4.11(b),CN-L3|8.1.10.2(c),CN-L3|8.1.10.6(a),CN-L3|8.5.3.1,CN-L3|8.5.4.1(a),CSCv7|14.6,CSCv8|3.3,CSF|PR.AC-4,CSF|PR.DS-5,CSF|PR.PT-2,CSF|PR.PT-3,CSF2.0|PR.AA-05,CSF2.0|PR.DS-10,CSF2.0|PR.IR-01,GDPR|32.1.b,HIPAA|164.306(a)(1),HIPAA|164.312(a)(1),ISO/IEC-27001|A.6.1.2,ISO/IEC-27001|A.9.4.1,ISO/IEC-27001|A.9.4.5,ITSG-33|AC-3,ITSG-33|AC-5,ITSG-33|AC-6,ITSG-33|MP-2,ITSG-33|MP-2a.,LEVEL|2M,NESA|T1.3.2,NESA|T1.3.3,NESA|T1.4.1,NESA|T4.2.1,NESA|T5.1.1,NESA|T5.2.2,NESA|T5.4.1,NESA|T5.4.4,NESA|T5.4.5,NESA|T5.5.4,NESA|T5.6.1,NESA|T7.5.2,NESA|T7.5.3,NIAv2|AM1,NIAv2|AM3,NIAv2|AM23f,NIAv2|SS13c,NIAv2|SS15c,NIAv2|SS29,PCI-DSSv3.2.1|7.1.2,PCI-DSSv4.0|7.2.1,PCI-DSSv4.0|7.2.2,QCSC-v1|3.2,QCSC-v1|5.2.2,QCSC-v1|6.2,QCSC-v1|13.2,SWIFT-CSCv1|5.1,TBA-FIISB|31.1,TBA-FIISB|31.4.2,TBA-FIISB|31.4.3"
  see_also       : "https://workbench.cisecurity.org/benchmarks/16820"
  request        : "listManagementLocksByResourceGroup"
  json_transform : '.[]|.subscriptionId as $subid|.resourceGroups[]|.name as $rgname|.value[]|"Subscription ID: \($subid), Resource Group: \($rgname), Lock Name: \(.name), Lock Type: \(.properties.level)"'
  not_expect     : ".+"
  severity       : MEDIUM
</custom_item>

</check_type>
